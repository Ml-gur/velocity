<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Velocity.OS | Sphere to Wheel Transition</title>

    <!-- PERFORMANCE: Preconnect to CDNs -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Three.js and OrbitControls -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- Load Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Michroma&family=Inter:wght@300;400;500;600&family=Rajdhani:wght@500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Load PrismJS for Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>

    <style>
        :root {
            --bg-color: #050505;
            --accent: #ef4444;
        }

        body {
            margin: 0;
            overflow: hidden;
            /* Hide scrollbars as animation is driven by wheel/touch event */
            font-family: 'Inter', sans-serif;
            background-color: #000;
            touch-action: none;
            /* Prevent browser bounce/zoom handling */
        }

        /* --- 3D CANVAS STYLES --- */
        #webgl-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        canvas {
            display: block;
        }

        /* --- TYPOGRAPHY EFFECTS --- */
        .text-stroke-red {
            -webkit-text-stroke: 1px #ef4444;
            color: transparent;
        }

        .text-glow {
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        /* --- UI UTILITIES --- */
        .hover-underline-animation {
            display: inline-block;
            position: relative;
        }

        .hover-underline-animation::after {
            content: '';
            position: absolute;
            width: 100%;
            transform: scaleX(0);
            height: 1px;
            bottom: -4px;
            left: 0;
            background-color: #ffffff;
            transform-origin: bottom right;
            transition: transform 0.3s ease-out;
        }

        .hover-underline-animation:hover::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        /* --- SECTION STYLES --- */
        .section-container {
            position: fixed;
            z-index: 140;
            text-align: left;
            pointer-events: none;
            mix-blend-mode: screen;
            transform-origin: center center;
            transition: all 0.1s ease-out;
            will-change: transform, opacity;
        }

        .section-label {
            font-size: 0.75rem;
            line-height: 1rem;
            color: #ef4444;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            font-family: 'Inter', sans-serif;
            margin-bottom: 0.5rem;
        }

        .unified-big-title {
            font-family: 'Michroma', sans-serif;
            font-size: 2.2rem;
            line-height: 1.15;
            color: #ffffff;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .unified-big-title {
                font-size: 1.5rem;
            }
        }

        .unified-desc {
            font-size: 0.95rem;
            font-family: 'Inter', sans-serif;
            color: #9ca3af;
            line-height: 1.6;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .unified-desc {
                white-space: normal;
                font-size: 0.85rem;
            }
        }

        /* Specific Positions */
        #why-section {
            top: 50%;
            left: 5%;
            transform: translate(0, -50%);
            width: 90vw;
            max-width: 1600px;
            display: none;
        }

        #hero-section {
            mix-blend-mode: screen;
            will-change: transform, opacity;
        }

        #hero-title {
            transition: color 0.1s linear;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
        }

        /* DUAL GRID */
        #dual-grid-section {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 140;
            display: none;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            will-change: transform, opacity;
        }

        .grid-container {
            width: 85vw;
            max-width: 1600px;
            height: 80vh;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 20vh;
        }

        #phil-col {
            grid-column: 2;
            grid-row: 1;
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
            padding-top: 10vh;
        }

        #meth-col {
            grid-column: 1;
            grid-row: 2;
            text-align: left;
            padding-left: 2rem;
            border-left: 4px solid white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-bottom: 10vh;
        }

        #phil-col .unified-desc,
        #meth-col .unified-desc {
            white-space: normal;
            max-width: 450px;
        }

        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
                gap: 5vh;
                height: auto;
                width: 90vw;
            }

            #phil-col {
                grid-column: 1;
                grid-row: 1;
                padding-top: 0;
                align-items: flex-end;
            }

            #meth-col {
                grid-column: 1;
                grid-row: 2;
                padding-bottom: 0;
                padding-left: 1rem;
                align-items: flex-start;
            }
        }

        /* MARQUEE */
        #marquee-section {
            position: fixed;
            top: 50%;
            left: 0;
            width: 100vw;
            transform: translateY(-50%);
            z-index: 130;
            pointer-events: none;
            overflow: hidden;
            display: none;
            background: linear-gradient(90deg, transparent 0%, rgba(0, 0, 0, 0.5) 20%, rgba(0, 0, 0, 0.5) 80%, transparent 100%);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2vh 0;
            mix-blend-mode: screen;
        }

        .marquee-track {
            display: flex;
            white-space: nowrap;
            will-change: transform;
        }

        .marquee-item {
            font-family: 'Michroma', sans-serif;
            font-size: 4rem;
            color: transparent;
            -webkit-text-stroke: 1px rgba(255, 255, 255, 0.3);
            padding-right: 4rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            display: flex;
            align-items: center;
        }

        @media (max-width: 768px) {
            .marquee-item {
                font-size: 2rem;
                padding-right: 2rem;
            }
        }

        .marquee-item span {
            color: #ef4444;
            margin-left: 2rem;
            font-weight: bold;
        }

        /* HIGHLIGHTER ANIMATION */
        .highlight-word {
            display: inline-block;
            position: relative;
            z-index: 1;
            padding: 0 4px;
            margin: 0 2px;
            color: #ffffff;
        }

        .highlight-word::before {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 0%;
            height: 100%;
            background-color: #ef4444;
            z-index: -1;
            transition: width 0.3s cubic-bezier(0.22, 0.61, 0.36, 1);
            transform: skewX(-10deg);
        }

        .highlight-word.active::before {
            width: 100%;
        }

        .cursor-blink {
            display: inline-block;
            width: 8px;
            height: 24px;
            background-color: #ef4444;
            animation: blink 1s step-end infinite;
            margin-left: 4px;
            vertical-align: middle;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        /* --- MARKETPLACE STYLES --- */
        #marketplace-wrapper {
            background-color: rgba(3, 3, 3, 0.85);
            background-image: radial-gradient(circle at 50% 0%, rgba(239, 68, 68, 0.1), transparent 60%);
            background-size: 100% 100%;
            transition: transform 1.62s cubic-bezier(0.75, 0, 0.25, 1);
            will-change: transform;
            backdrop-filter: blur(8px);
            
            /* SCROLLING OPTIMIZATIONS */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Critical for iOS momentum */
            scroll-behavior: smooth;
            scroll-padding-top: 120px; /* Space for sticky header */
            touch-action: pan-y; /* Allow vertical scrolling */
            overscroll-behavior-y: none; /* Prevent bounce affecting parent */
        }

        .marketplace-content-enter>* {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.86s ease, transform 0.86s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .marketplace-active .marketplace-content-enter>* {
            opacity: 1;
            transform: translateY(0);
        }

        .marketplace-active .marketplace-content-enter>*:nth-child(1) {
            transition-delay: 0.43s;
        }

        .marketplace-active .marketplace-content-enter>*:nth-child(2) {
            transition-delay: 0.54s;
        }

        .marketplace-active .marketplace-content-enter>*:nth-child(3) {
            transition-delay: 0.65s;
        }

        /* JERRYCAN CARD STYLES */
        .fuel-cell-card {
            clip-path: polygon(30px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 30px);
            background: rgba(20, 20, 20, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: transform 0.3s ease, border-color 0.3s ease, background 0.3s ease;
            position: relative;
            overflow: visible;
            backdrop-filter: blur(12px);
            opacity: 0;
            transform: translateY(20px);
            cursor: pointer;
            will-change: transform, opacity;
            display: flex;
            flex-direction: column;
        }

        .fuel-cell-card:hover {
            border-color: rgba(239, 68, 68, 0.6);
            transform: translateY(-5px) !important;
            background: rgba(30, 30, 30, 0.9);
            z-index: 10;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        /* Handle Indication */
        .fuel-cell-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 40px;
            height: 30px;
            border-right: 2px solid rgba(255, 255, 255, 0.1);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), transparent);
            z-index: 20;
            pointer-events: none;
        }

        .fuel-cell-card:hover::before {
            border-color: #ef4444;
        }

        .card-visual {
            height: 140px; /* Mobile height */
            width: 100%;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
        }
        
        @media (min-width: 768px) {
            .card-visual {
                height: 200px; /* Desktop height */
            }
        }

        .card-visual img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            opacity: 0.9;
        }

        .fuel-cell-card:hover .card-visual img {
            transform: scale(1.08);
            opacity: 1;
        }

        .card-visual-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent 60%);
            pointer-events: none;
            z-index: 1;
        }

        .price-stamp {
            position: absolute;
            top: 10px;
            right: 0;
            background: #ef4444;
            color: #000;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 800;
            font-size: 14px;
            padding: 4px 12px;
            clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%);
            z-index: 10;
            box-shadow: -2px 2px 10px rgba(0, 0, 0, 0.5);
        }

        /* Filter Pills */
        .filter-pill {
            position: relative;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #a1a1aa;
            padding: 8px 16px;
            border-radius: 9999px;
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
            cursor: pointer;
            flex-shrink: 0;
            margin-right: 8px;
        }

        .filter-pill:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: rgba(255, 255, 255, 0.2);
        }

        .filter-pill.active {
            background-color: #ef4444;
            color: white;
            border-color: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }

        /* Command Bar */
        .cmd-tab-btn {
            transition: all 0.2s ease;
        }

        .cmd-tab-btn.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* WORK CTA STYLES */
        #work-cta {
            transition: opacity 0.5s ease, transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: opacity, transform;
        }

        /* Modal Styles */
        #product-modal {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            transition: opacity 0.3s ease;
            opacity: 0;
            /* Hidden by default */
            pointer-events: none;
            /* No clicks when hidden */
        }

        /* Active state for visibility */
        #product-modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Keep hidden class logic for display:none (Tailwind) interaction */
        #product-modal.hidden {
            display: none;
        }

        #modal-content {
            background: #0a0a0a;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 100px rgba(239, 68, 68, 0.1);
            transform: scale(0.95);
            /* Start slightly smaller */
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #product-modal.active #modal-content {
            transform: scale(1);
            /* Scale up when active */
        }

        @media (min-width: 768px) {
            #modal-content {
                flex-direction: row;
            }
        }

        .spec-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .spec-item:last-child {
            border-bottom: none;
        }

        /* Page Overlay */
        #page-overlay {
            transform: translateY(-100%);
            transition: transform 0.6s cubic-bezier(0.85, 0, 0.15, 1);
        }

        #page-overlay.active {
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .instructions-overlay {
                display: none;
            }
        }

        /* Utils */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ef4444;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* PrismJS Custom Overrides */
        pre[class*="language-"] {
            margin: 0 !important;
            border-radius: 0 !important;
            background: #0f0f0f !important;
            text-shadow: none !important;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- NAVBAR -->
    <nav
        class="fixed top-0 left-0 w-full z-[200] px-4 md:px-8 py-4 md:py-6 flex justify-between items-center pointer-events-none">
        <div class="pointer-events-auto cursor-pointer group" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
            <h1
                class="font-['Michroma'] text-lg md:text-xl tracking-widest transition-all duration-500 bg-[length:200%_auto] hover:bg-right bg-gradient-to-r from-white via-red-500 to-white bg-clip-text text-transparent drop-shadow-[0_0_8px_rgba(255,255,255,0.2)]">
                VELOCITY<span class="text-white group-hover:text-transparent transition-colors duration-500">.OS</span>
            </h1>
        </div>
        <div id="nav-center"
            class="hidden md:flex pointer-events-auto bg-black/40 backdrop-blur-md border border-white/10 rounded-full px-10 py-3 space-x-12 shadow-[0_0_20px_rgba(0,0,0,0.5)]">
            <a href="javascript:void(0)" onclick="openPage('concept')"
                class="hover-underline-animation text-[11px] text-gray-400 uppercase tracking-[0.2em] font-semibold hover:text-white transition-colors duration-300">Concept</a>
            <a href="javascript:void(0)" onclick="openPage('engineering')"
                class="hover-underline-animation text-[11px] text-gray-400 uppercase tracking-[0.2em] font-semibold hover:text-white transition-colors duration-300">Engineering</a>
            <!-- Added ID and 'hidden' class to Configure button -->
            <a id="nav-configure-btn" href="javascript:void(0)" onclick="openPage('configure')"
                class="hidden hover-underline-animation text-[11px] text-gray-400 uppercase tracking-[0.2em] font-semibold hover:text-white transition-colors duration-300">Configure</a>
        </div>
        <div id="nav-right" class="pointer-events-auto flex items-center gap-6">
            <a href="javascript:void(0)" onclick="openPage('login')"
                class="hidden md:block text-xs font-['Michroma'] text-white tracking-wider transition-all duration-300 ease-in-out hover:text-red-400 hover:scale-110 hover:drop-shadow-[0_0_10px_rgba(220,38,38,0.8)]">LOGIN</a>
            <button onclick="toggleMobileMenu()"
                class="group flex flex-col justify-center items-end gap-1.5 w-8 h-8 cursor-pointer relative z-[200]">
                <span
                    class="block w-8 h-[2px] bg-white group-hover:bg-red-600 shadow-[0_0_8px_rgba(255,255,255,0.5)] transition-colors duration-300"></span>
                <span
                    class="block w-5 h-[2px] bg-white group-hover:w-8 group-hover:bg-red-600 shadow-[0_0_8px_rgba(255,255,255,0.5)] transition-all duration-300"></span>
                <span
                    class="block w-8 h-[2px] bg-white group-hover:bg-red-600 shadow-[0_0_8px_rgba(255,255,255,0.5)] transition-colors duration-300"></span>
            </button>
        </div>
    </nav>

    <!-- MOBILE MENU OVERLAY -->
    <div id="mobile-menu"
        class="fixed inset-0 z-[195] bg-black/95 backdrop-blur-xl flex flex-col items-center justify-center space-y-8 transition-transform duration-500 translate-x-full pointer-events-auto">
        <a href="javascript:void(0)" onclick="openPage('concept'); toggleMobileMenu()"
            class="text-2xl font-['Michroma'] text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400 hover:to-red-500 transition-all">CONCEPT</a>
        <a href="javascript:void(0)" onclick="openPage('engineering'); toggleMobileMenu()"
            class="text-2xl font-['Michroma'] text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400 hover:to-red-500 transition-all">ENGINEERING</a>
        <!-- Added ID and 'hidden' class to Mobile Configure button -->
        <a id="mobile-nav-configure-btn" href="javascript:void(0)" onclick="openPage('configure'); toggleMobileMenu()"
            class="hidden text-2xl font-['Michroma'] text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400 hover:to-red-500 transition-all">CONFIGURE</a>
        <a href="javascript:void(0)" onclick="openPage('login'); toggleMobileMenu()"
            class="text-xl font-['Michroma'] text-red-500 mt-8">LOGIN</a>
    </div>

    <!-- HERO SECTION TEXT -->
    <div id="hero-section"
        class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center z-[150] w-full px-4 pointer-events-none">
        <h1 id="hero-title"
            class="font-['Michroma'] text-4xl md:text-6xl lg:text-7xl font-bold tracking-tighter mb-8 drop-shadow-[0_0_25px_rgba(255,255,255,0.2)]">
            DESIGNING THE<br /><span id="hero-span">INVISIBLE</span>
        </h1>
        <div class="space-y-2">
            <p
                class="font-['Inter'] text-[10px] md:text-xs text-gray-400 tracking-[0.3em] uppercase max-w-2xl mx-auto leading-relaxed">
                A CURATED MARKETPLACE FOR THE NEXT GENERATION</p>
            <p
                class="font-['Inter'] text-[10px] md:text-xs text-gray-400 tracking-[0.3em] uppercase max-w-2xl mx-auto leading-relaxed">
                OF DIGITAL EXPERIENCES. CRAFTED WITH PRECISION.</p>
            <p
                class="font-['Inter'] text-[10px] md:text-xs text-red-500 tracking-[0.3em] uppercase max-w-2xl mx-auto leading-relaxed font-semibold drop-shadow-[0_0_10px_rgba(220,38,38,0.5)]">
                POWERED BY VIBE.</p>
        </div>
    </div>

    <!-- PHASE 2: "WHY" SECTION TEXT -->
    <div id="why-section" class="section-container">
        <h2 id="why-title" class="section-label"></h2>
        <div>
            <p id="why-sub1" class="unified-big-title"></p>
            <p id="why-sub2" class="unified-desc"></p>
            <span class="cursor-blink"></span>
        </div>
        <!-- WORK CTA (Moved inside flow) -->
        <div id="work-cta" class="mt-8 opacity-0 translate-y-4 transition-all duration-500 pointer-events-auto">
            <a href="javascript:void(0)" onclick="openPage('engineering')"
                class="group flex items-center gap-3 cursor-pointer">
                <div
                    class="w-8 h-8 border border-red-500 rounded-full flex items-center justify-center group-hover:bg-red-500 transition-all duration-300">
                    <svg class="w-3 h-3 text-red-500 group-hover:text-black transition-colors duration-300" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                    </svg>
                </div>
                <span
                    class="text-[10px] font-['Michroma'] text-red-500 tracking-widest group-hover:text-white transition-colors duration-300">EXPLORE
                    COMPONENTS</span>
            </a>
        </div>
    </div>

    <!-- MARQUEE SECTION -->
    <div id="marquee-section">
        <div class="marquee-track" id="marquee-track">
            <div class="marquee-item">VELOCITY.OS <span>///</span></div>
            <div class="marquee-item">PRECISION <span>///</span></div>
            <div class="marquee-item">PERFORMANCE <span>///</span></div>
            <div class="marquee-item">SCALABILITY <span>///</span></div>
            <div class="marquee-item">VELOCITY.OS <span>///</span></div>
            <div class="marquee-item">PRECISION <span>///</span></div>
        </div>
    </div>

    <!-- PHASE 3: DUAL GRID SECTION -->
    <div id="dual-grid-section">
        <div class="grid-container">
            <div class="grid-col right" id="phil-col">
                <h2 class="section-label" style="text-align: right;">The Philosophy</h2>
                <div>
                    <p id="phil-title" class="unified-big-title"></p>
                    <p id="phil-desc" class="unified-desc text-gray-400 text-sm leading-relaxed"></p>
                    <div id="phil-quote-container"
                        class="mt-4 text-sm font-semibold tracking-widest uppercase opacity-0 transition-opacity duration-500 text-right">
                        <span id="phil-quote" class="highlight-word">Function creates form.</span>
                    </div>
                </div>
            </div>
            <div class="grid-col" id="meth-col">
                <h2 class="section-label">The Methodology</h2>
                <div>
                    <p id="meth-title" class="unified-big-title"></p>
                    <p id="meth-desc" class="unified-desc text-gray-400 text-sm leading-relaxed"></p>
                    <div id="meth-keywords"
                        class="mt-4 text-sm font-semibold tracking-widest uppercase opacity-0 transition-opacity duration-500">
                        <span id="kw-1" class="highlight-word">Lightweight,</span>
                        <span id="kw-2" class="highlight-word">rigid,</span>
                        <span id="kw-3" class="highlight-word">and ready to race.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3D SCENE CONTAINER -->
    <div id="webgl-container"></div>

    <div class="instructions-overlay font-['Michroma'] text-xs tracking-widest border border-white/20 backdrop-blur-sm">
        SCROLL TO TRANSFORM
    </div>

    <!-- MARKETPLACE OVERLAY -->
    <div id="marketplace-wrapper" class="fixed inset-0 z-[190] translate-y-full overflow-y-auto">
        <main class="flex-grow w-full max-w-[1700px] mx-auto px-4 md:px-12 pt-32 pb-20 relative z-10">

            <!-- Header Section -->
            <div class="flex flex-col mb-8 md:mb-12">
                <!-- Title Line - One Line on Desktop (md+), Two on Mobile -->
                <div class="flex flex-col md:flex-row items-start md:items-baseline gap-0 md:gap-4 mb-2 md:mb-4">
                    <h2 class="font-['Michroma'] text-3xl md:text-7xl text-white tracking-tight leading-none">COMPONENT
                    </h2>
                    <h2 class="font-['Michroma'] text-3xl md:text-7xl text-stroke-red tracking-tight leading-none mt-[-2px] md:mt-0 md:ml-1"
                        style="-webkit-text-stroke: 1px #ef4444; color: transparent;">STORE</h2>
                </div>

                <!-- Description Line - One Line on Desktop (md+), Wrap on Mobile -->
                <div class="flex flex-col lg:flex-row lg:items-center gap-2 md:gap-4 lg:gap-8 mb-4 md:mb-6">
                    <p
                        class="font-['Inter'] text-xs md:text-sm text-gray-400 tracking-wide leading-relaxed max-w-none md:whitespace-nowrap">
                        High-performance UI/UX assets for mission-critical interfaces.
                    </p>
                    <div class="hidden lg:block h-px w-12 bg-white/20"></div>
                    <!-- Tagline - Always One Row -->
                    <p class="font-mono text-xs md:text-sm text-red-500 font-bold tracking-widest text-glow whitespace-nowrap overflow-x-auto scrollbar-hide"
                        style="text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);">
                        STRICTLY TYPED. MOTION-RICH. PRODUCTION READY.
                    </p>
                </div>
            </div>
            <!-- Redesigned Filter Command Bar (Static) -->
            <!-- Updated classes: Changed sticky to relative so it scrolls with content instead of floating over -->
            <div class="w-full mb-6 md:mb-8 relative z-20 transition-all duration-300 -mx-4 px-4 md:-mx-12 md:px-12 py-4 bg-[#050505]/95 backdrop-blur-xl border-b border-white/10 shadow-2xl"
                id="filter-bar">
                <div class="bg-white/5 border border-white/10 backdrop-blur-md rounded-md grid grid-cols-2 md:flex md:flex-row p-1 gap-1">
                    <!-- Left: Search (Full width on mobile grid, auto on desktop flex) -->
                    <div class="relative col-span-2 md:w-1/3 md:flex-grow-0">
                        <svg class="absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-500 w-4 h-4"
                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" id="search-input"
                            class="bg-transparent border-none text-white pl-10 pr-4 py-3 w-full font-['Inter'] text-sm focus:outline-none placeholder-gray-600"
                            placeholder="Search...">
                    </div>

                    <!-- Middle: Filters (Side by side on mobile) -->
                    <select onchange="updateAdminFilter('category', this.value)" class="col-span-1 md:w-auto bg-black/20 border-r border-white/5 text-white px-4 py-2 text-xs outline-none focus:bg-white/10 transition-colors uppercase cursor-pointer rounded-sm">
                        <option value="ALL" class="bg-black text-white">All Cats</option>
                        <option value="HERO" class="bg-black text-white">Hero</option>
                        <option value="SECTION" class="bg-black text-white">Section</option>
                        <option value="BUTTON" class="bg-black text-white">Button</option>
                        <option value="CARD" class="bg-black text-white">Card</option>
                        <option value="FEATURE" class="bg-black text-white">Feature</option>
                        <option value="FORM" class="bg-black text-white">Form</option>
                        <option value="HEADER" class="bg-black text-white">Header</option>
                        <option value="FOOTER" class="bg-black text-white">Footer</option>
                        <option value="PRICING" class="bg-black text-white">Pricing</option>
                        <option value="TESTIMONIAL" class="bg-black text-white">Testimonial</option>
                        <option value="GALLERY" class="bg-black text-white">Gallery</option>
                    </select>

                    <select onchange="updateAdminFilter('sort', this.value)" class="col-span-1 md:w-auto bg-black/20 text-white px-4 py-2 text-xs outline-none focus:bg-white/10 transition-colors uppercase cursor-pointer rounded-sm">
                        <option value="NEWEST" class="bg-black text-white">Newest</option>
                        <option value="POPULAR" class="bg-black text-white">Popular</option>
                        <option value="RATING" class="bg-black text-white">Rated</option>
                    </select>

                    <!-- Right: Tabs (Full width row on mobile if needed, or flexed) -->
                    <div class="col-span-2 md:w-auto flex gap-0.5 bg-black/30 p-0.5 rounded-sm md:ml-auto overflow-x-auto">
                        <button
                            class="cmd-tab-btn active px-4 py-2 text-xs font-['Rajdhani'] font-bold tracking-wider text-gray-400 hover:bg-white/5 rounded-sm transition-colors whitespace-nowrap flex-1 md:flex-none"
                            onclick="switchTab('trending')">TRENDING</button>
                        <button
                            class="cmd-tab-btn px-4 py-2 text-xs font-['Rajdhani'] font-bold tracking-wider text-gray-400 hover:bg-white/5 rounded-sm transition-colors whitespace-nowrap flex-1 md:flex-none"
                            onclick="switchTab('new')">NEW</button>
                        <button
                            class="cmd-tab-btn px-4 py-2 text-xs font-['Rajdhani'] font-bold tracking-wider text-gray-400 hover:bg-white/5 rounded-sm transition-colors whitespace-nowrap flex-1 md:flex-none"
                            onclick="switchTab('community')">COMMUNITY</button>
                    </div>
                </div>

                <!-- Category Pills Row (Outside command bar) -->
                <div class="mt-4 flex gap-2 overflow-x-auto w-full pb-2 no-scrollbar" id="filter-pills-container">
                    <!-- Pills injected via JS -->
                </div>
            </div>

            <!-- Dynamic Grid Container -->
            <!-- Updated Grid: grid-cols-2 on mobile, gap-3 on mobile -->
            <div id="cards-container"
                class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-6 min-h-[600px]">
                <!-- Cards injected via JS -->
            </div>

        </main>

        <!-- SYSTEM FOOTER -->
        <footer class="w-full border-t border-white/10 bg-black py-10 md:pt-16 md:pb-12 relative z-20">
            <div class="max-w-[1600px] mx-auto px-6 md:px-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 text-center md:text-left items-start">
                    <div>
                        <h3 class="font-['Michroma'] text-xl md:text-3xl mb-4 text-white">VELOCITY SYSTEMS</h3>
                        <div class="h-1 w-12 md:w-20 bg-red-600 mb-6 mx-auto md:mx-0"></div>
                        <p class="font-['Inter'] text-xs md:text-sm text-gray-400 leading-relaxed mb-4 max-w-md mx-auto md:mx-0">
                            The premier marketplace for high-performance, motion-rich digital components.
                        </p>
                        <div class="flex items-center gap-2 justify-center md:justify-start">
                            <span class="w-1.5 h-1.5 md:w-2 md:h-2 rounded-full bg-green-500 animate-pulse"></span>
                            <span class="text-[9px] md:text-[10px] font-mono text-gray-600 tracking-widest">SYSTEM STATUS: NOMINAL // v2.4.0 LIVE</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-6 md:gap-8 mt-4 md:mt-0">
                        <div>
                            <h4 class="section-label text-[10px] md:text-xs">ACTIVE DEVS</h4>
                            <p class="font-['Michroma'] text-base md:text-xl text-white">842</p>
                        </div>
                        <div>
                            <h4 class="section-label text-[10px] md:text-xs">ASSETS</h4>
                            <p class="font-['Michroma'] text-base md:text-xl text-white">156</p>
                        </div>
                        <div>
                            <h4 class="section-label text-[10px] md:text-xs">DOWNLOADS</h4>
                            <p class="font-['Michroma'] text-base md:text-xl text-white">1.2k</p>
                        </div>
                        <div>
                            <h4 class="section-label text-[10px] md:text-xs">VERSION</h4>
                            <p class="font-['Michroma'] text-base md:text-xl text-white">v2.4.0</p>
                        </div>
                    </div>
                </div>
                <div
                    class="mt-10 md:mt-20 pt-8 border-t border-white/5 flex flex-col md:flex-row justify-between items-center text-[9px] md:text-[10px] text-gray-600 font-['Michroma'] tracking-widest gap-4 md:gap-0">
                    <p>Â© 2024 VELOCITY SYSTEMS. ALL RIGHTS RESERVED.</p>
                    <div class="flex flex-wrap justify-center gap-4 md:gap-8">
                        <a href="#" class="hover:text-red-500 transition-colors">PRIVACY POLICY</a>
                        <a href="#" class="hover:text-red-500 transition-colors">TERMS OF SERVICE</a>
                        <a href="#" class="hover:text-red-500 transition-colors">CONTACT SUPPORT</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- PRODUCT MODAL (UPDATED WITH CODE VIEW & LIVE RENDER) -->
    <div id="product-modal"
        class="fixed inset-0 z-[210] flex items-center justify-center bg-black/90 backdrop-blur-xl p-4 hidden">
        <div id="modal-content"
            class="w-full max-w-6xl h-[90vh] rounded-lg flex flex-col md:flex-row relative bg-[#0a0a0a] border border-white/10 shadow-[0_0_100px_rgba(220,38,38,0.15)] overflow-hidden">
            <button onclick="closeProductModal()"
                class="absolute top-4 right-4 z-50 text-white/70 hover:text-white transition-colors bg-black/60 backdrop-blur-md border border-white/10 rounded-full p-2 hover:bg-red-600 hover:border-red-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <!-- LEFT: Preview / Code Area -->
            <div class="w-full md:w-7/12 flex flex-col border-b md:border-b-0 md:border-r border-white/10 bg-black">
                <!-- Toolbar -->
                <div class="flex border-b border-white/10 bg-[#0a0a0a] relative">
                    <button id="btn-view-preview" onclick="switchModalView('preview')"
                        class="flex-1 py-3 text-[10px] font-['Michroma'] tracking-widest text-white bg-white/5 border-r border-white/10 transition-colors">PREVIEW</button>
                    <button id="btn-view-code" onclick="switchModalView('code')"
                        class="flex-1 py-3 text-[10px] font-['Michroma'] tracking-widest text-gray-500 hover:text-white hover:bg-white/5 transition-colors">SOURCE
                        CODE</button>

                    <!-- Copy Button (Hidden by default) -->
                    <button id="btn-copy-code" onclick="copyCodeToClipboard()"
                        class="hidden absolute right-0 top-0 bottom-0 px-6 text-[10px] font-['Michroma'] tracking-widest text-red-500 hover:text-white hover:bg-red-600 transition-all flex items-center gap-2 border-l border-white/10 z-10 bg-[#0a0a0a]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        <span>COPY</span>
                    </button>
                </div>

                <!-- Content Area -->
                <div class="relative flex-grow overflow-hidden bg-[#050505] group">
                    <!-- PREVIEW STAGE -->
                    <div id="view-preview" class="absolute inset-0 w-full h-full flex items-center justify-center">
                        <img id="modal-image" src="" alt="Component Preview"
                            class="w-full h-full object-cover opacity-90 transition-opacity duration-500">
                        <!-- Secure Iframe for HTML Components -->
                        <iframe id="modal-iframe"
                            class="hidden absolute inset-0 w-full h-full border-none bg-white"></iframe>
                        <div
                            class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent pointer-events-none">
                        </div>
                    </div>

                    <!-- CODE STAGE -->
                    <div id="view-code"
                        class="absolute inset-0 w-full h-full hidden overflow-auto custom-scrollbar bg-[#0f0f0f] p-0">
                        <pre
                            class="m-0 !bg-transparent h-full"><code id="modal-code-block" class="language-html text-xs font-mono text-gray-300 leading-relaxed block p-6"></code></pre>
                    </div>

                    <!-- Price Tag (Overlay) -->
                    <div id="modal-price"
                        class="absolute top-6 left-6 bg-red-600 text-white font-['Rajdhani'] font-bold text-xl px-4 py-1 shadow-lg tracking-wider pointer-events-none z-20">
                    </div>
                </div>
            </div>

            <!-- RIGHT: Details -->
            <div class="w-full md:w-5/12 p-8 md:p-10 flex flex-col bg-[#080808] overflow-y-auto custom-scrollbar">
                <div class="flex justify-between items-start mb-4">
                    <div id="modal-category"
                        class="text-xs font-['Michroma'] text-red-500 tracking-[0.2em] uppercase border border-red-500/30 px-3 py-1.5 rounded-sm bg-red-500/5">
                    </div>
                    <div class="flex gap-2 items-center">
                        <span
                            class="w-2 h-2 rounded-full bg-green-500 animate-pulse shadow-[0_0_10px_rgba(34,197,94,0.6)]"></span>
                        <span class="text-[10px] font-mono text-gray-400 tracking-wider">LIVE</span>
                    </div>
                </div>

                <h2 id="modal-title"
                    class="font-['Rajdhani'] font-bold text-4xl md:text-5xl text-white mb-6 leading-none tracking-wide">
                </h2>
                <p id="modal-description"
                    class="font-['Inter'] text-sm text-gray-300 leading-7 mb-8 border-l-2 border-red-600/50 pl-5"></p>

                <div class="bg-white/5 rounded border border-white/10 p-5 mb-8">
                    <h4 class="text-[10px] font-['Michroma'] text-gray-400 mb-3 border-b border-white/10 pb-2">
                        TECHNICAL SPECIFICATIONS</h4>
                    <div class="space-y-0">
                        <div class="spec-item">
                            <span class="text-xs text-gray-500 font-mono">FRAMEWORK</span>
                            <span id="modal-spec-lang"
                                class="text-xs text-white font-['Michroma'] tracking-wide">HTML/CSS</span>
                        </div>
                        <div class="spec-item">
                            <span class="text-xs text-gray-500 font-mono">LICENSE</span>
                            <span class="text-xs text-white font-['Michroma'] tracking-wide">Commercial</span>
                        </div>
                        <div class="spec-item">
                            <span class="text-xs text-gray-500 font-mono">SIZE</span>
                            <span class="text-xs text-white font-['Michroma'] tracking-wide">45.2 KB</span>
                        </div>
                    </div>
                </div>

                <div class="mt-auto flex flex-col gap-3">
                    <button
                        class="w-full py-4 text-xs font-['Michroma'] bg-red-600 text-white border border-red-600 hover:bg-red-700 hover:border-red-700 transition-all duration-300 rounded-sm shadow-[0_0_20px_rgba(220,38,38,0.4)] hover:shadow-[0_0_30px_rgba(220,38,38,0.6)] uppercase tracking-widest flex items-center justify-center gap-3">
                        <span>Add to Cart</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M5 12h14"></path>
                            <path d="M12 5l7 7-7 7"></path>
                        </svg>
                    </button>
                    <button
                        class="w-full py-3 text-[10px] font-['Michroma'] border border-white/10 text-gray-400 hover:text-white hover:border-white/30 hover:bg-white/5 transition-all duration-300 rounded-sm uppercase tracking-widest">
                        View Documentation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- FULL PAGE OVERLAY -->
    <div id="page-overlay" class="fixed inset-0 z-[250] bg-[#050505] flex flex-col pointer-events-none">
        <button onclick="closePage()"
            class="absolute top-6 right-8 text-gray-400 hover:text-white z-50 pointer-events-auto transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <div id="page-content"
            class="flex-grow overflow-y-auto p-8 md:p-20 pt-32 flex flex-col items-center justify-center opacity-0 transition-opacity duration-500 pointer-events-auto">
            <div class="max-w-4xl w-full">
                <h1 id="page-overlay-title"
                    class="text-4xl md:text-7xl font-['Michroma'] text-white mb-8 border-l-4 border-red-600 pl-6 leading-tight">
                    PAGE TITLE</h1>
                <div id="page-overlay-body"
                    class="text-lg md:text-xl text-gray-400 font-['Inter'] leading-relaxed space-y-6"></div>
            </div>
        </div>
        <div id="concept-frame-container"
            class="absolute inset-0 z-40 hidden w-full h-full bg-black pointer-events-auto"></div>
    </div>

    <script>
        const TXT_TITLE = "WHY VELOCITY.OS?";
        const TXT_SUB1 = "Built for the future of web.";
        const TXT_SUB2 = "We don't just sell code. We sell an implementation strategy that scales.";
        const METH_TITLE = "Race-Spec Architecture.";
        const METH_DESC = "Built with the same precision engineering found in the paddock.";
        const PHIL_TITLE = "Craftsmanship. At Scale.";
        const PHIL_DESC = "Don't just build a UI. Orchestrate an experience. Velocity.os delivers the motion-rich, accessible, and strictly typed foundations that top engineering teams rely on to ship awards.";

        // --- CONCEPT HTML ---
        const CONCEPT_HTML = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>MotoGP Wheel</title><style>body{margin:0;background-color:#050505;color:#fff;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;overflow-x:hidden}#canvas-container{width:100%;height:100vh;position:fixed;top:0;left:0;z-index:1}canvas{display:block;outline:0}#main-header{position:fixed;top:80px;width:100%;text-align:center;z-index:4;pointer-events:none;transition:opacity .5s ease}#main-header h1{font-family:'Arial Black',sans-serif;font-size:42px;text-transform:uppercase;margin:0 0 10px 0;letter-spacing:-1px;color:#fff;text-shadow:0 10px 30px rgba(0,0,0,.5)}#main-header p{font-family:monospace;font-size:13px;color:#888;margin:0;letter-spacing:1px;line-height:1.5;text-transform:uppercase}#overlay-container{position:fixed;bottom:5%;left:50%;transform:translateX(-50%);z-index:3;pointer-events:none;mix-blend-mode:difference;max-width:600px;width:100%;perspective:1000px;text-align:center}.theme-section{position:absolute;bottom:0;left:0;width:100%;opacity:0;transform:rotateX(20deg) translateY(40px);transform-origin:center bottom;transition:opacity .2s ease,transform .3s ease;pointer-events:none;will-change:opacity,transform;display:flex;flex-direction:column;align-items:center}.theme-section.active{opacity:1;transform:rotateX(0) translateY(0);pointer-events:auto;transition:opacity 1s ease,transform 1.2s cubic-bezier(.23,1,.32,1)}.theme-header{font-size:11px;letter-spacing:4px;text-transform:uppercase;color:#ff3333;margin-bottom:12px;font-weight:700;display:flex;align-items:center;justify-content:center;opacity:0;transform:translateY(10px);transition:opacity .1s ease,transform .1s ease}.theme-section.active .theme-header{opacity:1;transform:translateY(0);transition:opacity .6s ease .1s,transform .6s cubic-bezier(.23,1,.32,1) .1s}.theme-header::after,.theme-header::before{content:'';display:inline-block;width:30px;height:2px;background:#ff3333;transform:scaleX(0);transition:transform .1s ease}.theme-header::before{margin-right:15px;transform-origin:right}.theme-header::after{margin-left:15px;transform-origin:left}.theme-section.active .theme-header::after,.theme-section.active .theme-header::before{transform:scaleX(1);transition:transform .6s cubic-bezier(.23,1,.32,1)}.theme-title{font-size:56px;font-weight:900;line-height:.9;margin-bottom:15px;text-transform:uppercase;font-family:'Arial Black',sans-serif;color:#fff;letter-spacing:-2px;clip-path:inset(0 0 100% 0);transform:translateY(10px);transition:clip-path .2s ease,transform .2s ease}.theme-section.active .theme-title{clip-path:inset(0 0 0 0);transform:translateY(0);transition:clip-path 1s cubic-bezier(.19,1,.22,1) .2s,transform 1s cubic-bezier(.19,1,.22,1) .2s}.theme-desc{font-size:13px;line-height:1.6;color:#ccc;font-family:monospace;text-transform:uppercase;letter-spacing:1px;border-top:1px solid #444;padding-top:15px;opacity:0;clip-path:inset(0 100% 0 0);transition:opacity .2s ease,clip-path .2s ease}.theme-section.active .theme-desc{opacity:1;clip-path:inset(0 0 0 0);transition:opacity .8s ease .4s,clip-path 1.2s cubic-bezier(.19,1,.22,1) .4s}#scroll-spacer{height:4000px;position:relative;z-index:0;pointer-events:none}.scroll-instruction{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#444;animation:pulse 2s infinite;z-index:2;pointer-events:none;font-family:monospace;font-size:10px;letter-spacing:2px}@keyframes pulse{0%{opacity:.1}50%{opacity:.6}100%{opacity:.1}}
        /* NEW BLOG STYLES */
        #concept-blogs {position: relative;z-index: 10;background: linear-gradient(to bottom, transparent 0%, #050505 15%);padding: 100px 10% 100px 10%;margin-top: -50vh;pointer-events: auto;color: #fff;max-width: 1000px;margin-left: auto;margin-right: auto;}
        .blog-post {margin-bottom: 120px;position: relative;opacity: 0.8;transition: opacity 0.3s;padding-left: 30px;border-left: 2px solid #222;}
        .blog-post:hover {opacity: 1;border-left-color: #ef4444;}
        .blog-header {font-family: 'Arial Black', sans-serif;font-size: 36px;color: #fff;margin-bottom: 20px;text-transform: uppercase;letter-spacing: -1px;line-height: 1;}
        .blog-header span {color: #ef4444;font-size: 12px;display: block;margin-bottom: 10px;letter-spacing: 3px;font-family: monospace;font-weight: normal;}
        .blog-content {font-family: 'Segoe UI', sans-serif;font-size: 16px;line-height: 1.8;color: #999;max-width: 700px;}
        .blog-content p {margin-bottom: 20px;}
        @media(max-width: 768px) {#concept-blogs { padding: 50px 5%; margin-top: -30vh; }.blog-header { font-size: 28px; }.blog-post { padding-left: 20px; margin-bottom: 80px; }}
        </style><script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js","three/addons/":"https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"}}<\/script></head><body><div id="main-header"><h1>Velocity Concept</h1><p>THE NEXT GENERATION OF DIGITAL EXPERIENCES<br>CRAFTED WITH PRECISION. POWERED BY VIBE.</p></div><div id="overlay-container"><div id="theme-concept" class="theme-section"><div class="theme-header">PHASE 01 // VISION</div><div class="theme-title">DIGITAL<br>EXPERIENCES</div><div class="theme-desc">[>] NEXT GENERATION MARKETPLACE &nbsp;&nbsp; [>] POWERED BY VIBE</div></div><div id="theme-engineering" class="theme-section"><div class="theme-header">PHASE 02 // PRECISION</div><div class="theme-title">CRAFTED<br>CODE</div><div class="theme-desc">[>] PIXEL PERFECT &nbsp;&nbsp; [>] PERFORMANCE FIRST</div></div><div id="theme-configure" class="theme-section"><div class="theme-header">PHASE 03 // VELOCITY</div><div class="theme-title">SYSTEM<br>READY</div><div class="theme-desc">[>] SHIP AWARDS &nbsp;&nbsp; [>] NOT JUST CODE</div></div></div><div class="scroll-instruction">SCROLL TO ACTIVATE</div><div id="canvas-container"></div><div id="scroll-spacer"></div>
        <section id="concept-blogs"><div class="blog-post"><div class="blog-header"><span>PHASE 01</span>VISION</div><div class="blog-content"><p>The digital landscape is cluttered. We envision a streamlined ecosystem where design meets function without friction. Velocity.OS starts here: defining the core aesthetics and the unsprung mass of the web.</p><p>It is not just about looking good; it is about the "why". Every pixel must earn its place on the screen. We strip away the noise to reveal the signal. We are building the substrate for the next generation of internet artifacts.</p></div></div><div class="blog-post"><div class="blog-header"><span>PHASE 02</span>PRECISION</div><div class="blog-content"><p>Engineering is an art form. We treat code like a machined component. Strict typing, optimized render cycles, and lightweight architectures ensure that Velocity components perform under pressure.</p><p>Forged in the fires of high-performance requirements, our assets are rigid, reliable, and ready to race. No bloat, just power. We measure latency in microseconds and design in sub-pixels.</p></div></div><div class="blog-post"><div class="blog-header"><span>PHASE 03</span>VELOCITY</div><div class="blog-content"><p>Speed is the ultimate feature. From development time to runtime performance, Velocity.OS is designed to accelerate your workflow.</p><p>We provide the tools to ship awards, not just code. The system is ready. The track is clear. Are you? Join the movement and start building faster, better, and with more vibe than ever before.</p></div></div></section>
        <script type="module">import*as THREE from'three';import{OrbitControls}from'three/addons/controls/OrbitControls.js';const mainHeader=document.getElementById('main-header');const themeConcept=document.getElementById('theme-concept');const themeEngineering=document.getElementById('theme-engineering');const themeConfigure=document.getElementById('theme-configure');const overlayContainer=document.getElementById('overlay-container');const CONFIG={tireRadius:10,tireTube:3.5,rimRadius:5.8,rimWidth:5,spokeCount:7,brakeDiscRadius:4.5};const scene=new THREE.Scene();scene.background=new THREE.Color(0x050505);scene.fog=new THREE.FogExp2(0x050505,.02);const camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1000);camera.position.set(0,5,45);camera.lookAt(0,0,0);const renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0});renderer.setSize(window.innerWidth,window.innerHeight);renderer.setPixelRatio(window.devicePixelRatio);renderer.shadowMap.enabled=!0;renderer.shadowMap.type=THREE.PCFSoftShadowMap;document.getElementById('canvas-container').appendChild(renderer.domElement);const controls=new OrbitControls(camera,renderer.domElement);controls.enableDamping=!0;controls.dampingFactor=.05;controls.minDistance=10;controls.maxDistance=60;controls.enableZoom=!1;function createBrakeDiscTexture(){const canvas=document.createElement('canvas');canvas.width=512;canvas.height=512;const ctx=canvas.getContext('2d');ctx.fillStyle='#FFFFFF';ctx.fillRect(0,0,512,512);ctx.fillStyle='#000000';const centerX=256;const centerY=256;for(let r=100;r<230;r+=25){const circumference=2*Math.PI*r;const holeCount=Math.floor(circumference/20);for(let i=0;i<holeCount;i++){const angle=i/holeCount*Math.PI*2;const offsetR=r+(Math.random()*5-2.5);const x=centerX+Math.cos(angle)*offsetR;const y=centerY+Math.sin(angle)*offsetR;ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fill()}}const texture=new THREE.CanvasTexture(canvas);texture.anisotropy=16;return texture}function createTireTexture(){const canvas=document.createElement('canvas');canvas.width=1024;canvas.height=1024;const ctx=canvas.getContext('2d');ctx.fillStyle='#111111';ctx.fillRect(0,0,1024,1024);for(let i=0;i<1000;i++){ctx.fillStyle=\`rgba(255,255,255,\${Math.random()*.05})\`;ctx.fillRect(Math.random()*1024,Math.random()*1024,2,2)}ctx.save();ctx.translate(512,512);function drawCurvedText(text,radius,startAngle,color,fontSize,angleSpacing=.15){ctx.font=\`900 \${fontSize}px Arial\`;ctx.fillStyle=color;ctx.textAlign='center';ctx.textBaseline='middle';const totalAngle=text.length*angleSpacing;let currentAngle=startAngle-totalAngle/2;text.split('').forEach(char=>{ctx.save();ctx.rotate(currentAngle);ctx.translate(0,-radius);ctx.fillText(char,0,0);ctx.restore();currentAngle+=angleSpacing})}drawCurvedText("VELOCITY OS",350,0,"#ffffff",60,.10);ctx.rotate(Math.PI/4);ctx.fillStyle='#FFCC00';ctx.fillRect(-60,-320,120,40);ctx.fillStyle='#000000';ctx.font='bold 20px Arial';ctx.fillText("WARNING",0,-300);ctx.restore();const texture=new THREE.CanvasTexture(canvas);texture.anisotropy=16;return texture}const rubberMaterial=new THREE.MeshStandardMaterial({color:0x1a1a1a,roughness:.6,metalness:.1,map:createTireTexture(),bumpMap:createTireTexture(),bumpScale:.02});const slickMaterial=new THREE.MeshStandardMaterial({color:0x151515,roughness:.7,metalness:0});const rimMaterial=new THREE.MeshStandardMaterial({color:0x080808,roughness:.4,metalness:.8});const rimStripeMaterial=new THREE.MeshStandardMaterial({color:0xff0000,emissive:0x990000,emissiveIntensity:.5,roughness:.2,metalness:.5});const brakeDiscMap=createBrakeDiscTexture();const brakeDiscMaterial=new THREE.MeshStandardMaterial({color:0xaaaaaa,map:brakeDiscMap,alphaMap:brakeDiscMap,transparent:!0,side:THREE.DoubleSide,roughness:.3,metalness:.9});const hubMaterial=new THREE.MeshStandardMaterial({color:0x333333,roughness:.5,metalness:.7});const axleMaterial=new THREE.MeshStandardMaterial({color:0x555555,roughness:.6,metalness:.6});const wheelAssembly=new THREE.Group();wheelAssembly.rotation.x=-Math.PI/2;scene.add(wheelAssembly);const axleGeo=new THREE.CylinderGeometry(.5,.5,7,16);axleGeo.rotateX(Math.PI/2);const axle=new THREE.Mesh(axleGeo,axleMaterial);wheelAssembly.add(axle);const rotatingGroup=new THREE.Group();wheelAssembly.add(rotatingGroup);const tireGroup=new THREE.Group();const rimGroup=new THREE.Group();const brakeGroup=new THREE.Group();rotatingGroup.add(tireGroup);rotatingGroup.add(rimGroup);rotatingGroup.add(brakeGroup);const tireGeo=new THREE.TorusGeometry(CONFIG.tireRadius,CONFIG.tireTube,32,64);const tire=new THREE.Mesh(tireGeo,rubberMaterial);tire.scale.set(1,1,1.8);const sidewallGeo=new THREE.RingGeometry(CONFIG.rimRadius,CONFIG.tireRadius+CONFIG.tireTube/2,64);const sidewallLeft=new THREE.Mesh(sidewallGeo,rubberMaterial);sidewallLeft.position.z=2.5;sidewallLeft.rotation.y=Math.PI;const sidewallRight=new THREE.Mesh(sidewallGeo,rubberMaterial);sidewallRight.position.z=-2.5;const slickGeo=new THREE.CylinderGeometry(CONFIG.tireRadius+CONFIG.tireTube-.2,CONFIG.tireRadius+CONFIG.tireTube-.2,5,64,1,!0);slickGeo.rotateX(Math.PI/2);const slick=new THREE.Mesh(slickGeo,slickMaterial);const edgeGeo=new THREE.TorusGeometry(CONFIG.tireRadius+1.5,1.8,16,64);const edgeMesh=new THREE.Mesh(edgeGeo,slickMaterial);edgeMesh.scale.set(1,1,1.4);tireGroup.add(sidewallLeft);tireGroup.add(sidewallRight);tireGroup.add(slick);tireGroup.add(edgeMesh);const rimCylGeo=new THREE.CylinderGeometry(CONFIG.rimRadius,CONFIG.rimRadius,CONFIG.rimWidth,64,1,!0);rimCylGeo.rotateX(Math.PI/2);const rim=new THREE.Mesh(rimCylGeo,rimMaterial);rimGroup.add(rim);const rimLipGeo=new THREE.TorusGeometry(CONFIG.rimRadius-.1,.2,16,64);const rimLip1=new THREE.Mesh(rimLipGeo,rimMaterial);rimLip1.position.z=CONFIG.rimWidth/2;const rimLip2=rimLip1.clone();rimLip2.position.z=-CONFIG.rimWidth/2;rimGroup.add(rimLip1);rimGroup.add(rimLip2);const rimStripeGeo=new THREE.TorusGeometry(CONFIG.rimRadius-.05,.05,16,100);const rimStripe1=new THREE.Mesh(rimStripeGeo,rimStripeMaterial);rimStripe1.position.z=CONFIG.rimWidth/2+.1;const rimStripe2=rimStripe1.clone();rimStripe2.position.z=-CONFIG.rimWidth/2-.1;rimGroup.add(rimStripe1);rimGroup.add(rimStripe2);for(let i=0;i<CONFIG.spokeCount;i++){const angle=i/CONFIG.spokeCount*Math.PI*2;const spokeGeo=new THREE.CylinderGeometry(.4,.2,CONFIG.rimRadius-1,8);const spoke=new THREE.Mesh(spokeGeo,rimMaterial);spoke.position.x=Math.cos(angle)*(CONFIG.rimRadius/2);spoke.position.y=Math.sin(angle)*(CONFIG.rimRadius/2);spoke.rotation.z=angle-Math.PI/2;spoke.rotation.x=Math.PI/2;spoke.rotation.set(0,0,angle-Math.PI/2);rimGroup.add(spoke)}const hubGeo=new THREE.CylinderGeometry(1.5,1.5,6,32);hubGeo.rotateX(Math.PI/2);const hub=new THREE.Mesh(hubGeo,hubMaterial);rimGroup.add(hub);const discGeo=new THREE.RingGeometry(2.5,CONFIG.brakeDiscRadius,64);const disc=new THREE.Mesh(discGeo,brakeDiscMaterial);disc.position.z=1.8;const discBack=disc.clone();discBack.rotation.y=Math.PI;discBack.position.z=1.9;const carrierGeo=new THREE.RingGeometry(1.5,2.5,32);const carrierMat=new THREE.MeshStandardMaterial({color:0x000000,metalness:.8,roughness:.5});const carrier=new THREE.Mesh(carrierGeo,carrierMat);carrier.position.z=1.85;brakeGroup.add(disc);brakeGroup.add(discBack);brakeGroup.add(carrier);const boltGeo=new THREE.CylinderGeometry(.1,.1,.2,8);const boltMat=new THREE.MeshStandardMaterial({color:0xaaaaaa});for(let i=0;i<5;i++){const angle=i/5*Math.PI*2;const bolt=new THREE.Mesh(boltGeo,boltMat);bolt.rotateX(Math.PI/2);bolt.position.set(Math.cos(angle)*2.5,Math.sin(angle)*2.5,1.9);brakeGroup.add(bolt)}const ambientLight=new THREE.AmbientLight(0xffffff,.2);scene.add(ambientLight);const spotLight=new THREE.SpotLight(0xffffff,400);spotLight.position.set(-10,30,20),spotLight.angle=Math.PI/6,spotLight.penumbra=.3,spotLight.castShadow=!0,spotLight.shadow.mapSize.width=512,spotLight.shadow.mapSize.height=512,scene.add(spotLight);const rimLight1=new THREE.PointLight(0xffffff,200);rimLight1.position.set(15,5,5);scene.add(rimLight1);const rimLight2=new THREE.PointLight(0xff0000,300);rimLight2.position.set(-5,-10,5);scene.add(rimLight2);const clock=new THREE.Clock();let smoothedScroll=0;const animationRange=4000;function animate(){requestAnimationFrame(animate);const time=clock.getElapsedTime();rotatingGroup.rotation.z=time*-.5;const currentScrollY=window.scrollY;const animationProgress=Math.min(Math.max(currentScrollY/animationRange,0),1);smoothedScroll+=(animationProgress-smoothedScroll)*.04;const standProgress=Math.min(smoothedScroll/.15,1);wheelAssembly.rotation.x=THREE.MathUtils.lerp(-Math.PI/2,0,standProgress);if(mainHeader)mainHeader.style.opacity=1-Math.min(smoothedScroll*10,1);if(currentScrollY>animationRange){overlayContainer.style.opacity=0;overlayContainer.style.transition='opacity 0.5s ease'}else{overlayContainer.style.opacity=1}if(themeConcept&&themeEngineering&&themeConfigure){themeConcept.classList.remove('active');themeEngineering.classList.remove('active');themeConfigure.classList.remove('active');if(smoothedScroll<.18){themeConcept.classList.add('active')}else if(smoothedScroll>=.22&&smoothedScroll<.59){themeEngineering.classList.add('active')}else if(smoothedScroll>=.59&&currentScrollY<=animationRange){themeConfigure.classList.add('active')}}const tireScroll=Math.max(0,smoothedScroll-.08);tireGroup.position.z=tireScroll*320;const rimScroll=Math.max(0,smoothedScroll-.22);rimGroup.position.z=rimScroll*122;const brakeScroll=Math.max(0,smoothedScroll-.59);brakeGroup.position.z=brakeScroll*30;if(standProgress>=1){wheelAssembly.rotation.y=Math.sin(time*.5)*.1+smoothedScroll*.5}else{wheelAssembly.rotation.y=0}controls.update();renderer.render(scene,camera)}window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)});animate();<\/script></body></html>`;

        // --- ENGINEERING HTML ---
        // New interactive architecture visualization page
        const ENGINEERING_HTML = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Velocity Engineering</title><style>body{margin:0;background-color:#000;color:#0f0;font-family:'Courier New',Courier,monospace;overflow:hidden}.hud-container{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10}.grid-bg{position:absolute;top:0;left:0;width:100%;height:100%;background-image:linear-gradient(rgba(0,50,0,.2) 1px,transparent 1px),linear-gradient(90deg,rgba(0,50,0,.2) 1px,transparent 1px);background-size:40px 40px;opacity:.5;z-index:0}.tech-card{position:absolute;background:rgba(0,20,0,.8);border:1px solid #0f0;padding:15px;width:200px;font-size:12px;box-shadow:0 0 10px rgba(0,255,0,.2)}.tech-title{font-weight:700;border-bottom:1px solid #0f0;margin-bottom:5px;padding-bottom:2px}.tech-stat{display:flex;justify-content:space-between;margin-top:2px}.fps-counter{position:absolute;top:20px;right:20px;color:#0f0;font-size:24px;font-weight:700}.system-status{position:absolute;bottom:20px;left:20px;color:#0f0;font-size:12px}canvas#node-canvas{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1}</style></head><body><div class="grid-bg"></div><canvas id="node-canvas"></canvas><div class="hud-container"><div class="fps-counter">60 FPS <span style="font-size:12px;opacity:.7">LOCKED</span></div><div class="system-status">SYSTEM ARCHITECTURE // DIAGNOSTIC MODE<br>KERNEL: ACTIVE | MODULES: 4/4 | LATENCY: 1.2ms</div><div class="tech-card" style="top:20%;left:10%"><div class="tech-title">RENDER CORE</div><div class="tech-stat"><span>TYPE:</span><span>WebGL 2.0</span></div><div class="tech-stat"><span>SHADERS:</span><span>CUSTOM</span></div><div class="tech-stat"><span>STATUS:</span><span>ONLINE</span></div></div><div class="tech-card" style="top:50%;left:15%"><div class="tech-title">PHYSICS ENGINE</div><div class="tech-stat"><span>LANG:</span><span>RUST (WASM)</span></div><div class="tech-stat"><span>THREAD:</span><span>WORKER</span></div><div class="tech-stat"><span>DELTA:</span><span>16ms</span></div></div><div class="tech-card" style="top:30%;right:10%"><div class="tech-title">RECONCILER</div><div class="tech-stat"><span>FRAMEWORK:</span><span>REACT 18</span></div><div class="tech-stat"><span>MODE:</span><span>CONCURRENT</span></div><div class="tech-stat"><span>FIBER:</span><span>ACTIVE</span></div></div><div class="tech-card" style="top:60%;right:15%"><div class="tech-title">ASSET PIPELINE</div><div class="tech-stat"><span>CDN:</span><span>CLOUDINARY</span></div><div class="tech-stat"><span>FORMAT:</span><span>WEBP/GLB</span></div><div class="tech-stat"><span>COMPRESSION:</span><span>BROTLI</span></div></div></div><script>const canvas=document.getElementById('node-canvas');const ctx=canvas.getContext('2d');let width=canvas.width=window.innerWidth;let height=canvas.height=window.innerHeight;const nodes=[];const connections=[];const cursor={x:width/2,y:height/2};window.addEventListener('resize',()=>{width=canvas.width=window.innerWidth;height=canvas.height=window.innerHeight});window.addEventListener('mousemove',e=>{cursor.x=e.clientX;cursor.y=e.clientY});class Node{constructor(x,y){this.x=x;this.y=y;this.vx=(Math.random()-.5)*1.5;this.vy=(Math.random()-.5)*1.5;this.size=Math.random()*2+1}update(){this.x+=this.vx;this.y+=this.vy;if(this.x<0||this.x>width)this.vx*=-1;if(this.y<0||this.y>height)this.vy*=-1;const dx=this.x-cursor.x;const dy=this.y-cursor.y;const dist=Math.sqrt(dx*dx+dy*dy);if(dist<150){this.x+=dx/dist*2;this.y+=dy/dist*2}}draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fillStyle='#00ff00';ctx.fill()}}for(let i=0;i<40;i++)nodes.push(new Node(Math.random()*width,Math.random()*height));function animate(){ctx.clearRect(0,0,width,height);ctx.strokeStyle='rgba(0, 255, 0, 0.15)';ctx.lineWidth=1;for(let i=0;i<nodes.length;i++){nodes[i].update();nodes[i].draw();for(let j=i+1;j<nodes.length;j++){const dx=nodes[i].x-nodes[j].x;const dy=nodes[i].y-nodes[j].y;const dist=Math.sqrt(dx*dx+dy*dy);if(dist<150){ctx.beginPath();ctx.moveTo(nodes[i].x,nodes[i].y);ctx.lineTo(nodes[j].x,nodes[j].y);ctx.stroke()}}}requestAnimationFrame(animate)}animate();<\/script></body></html>`;

        const LOGIN_HTML = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>MotoGP Wheel Simulation</title><style>body{margin:0;overflow:hidden;background-color:#050505;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;-webkit-tap-highlight-color:transparent}canvas{display:block;position:fixed;top:0;left:0;z-index:0}#signup-container{position:relative;top:auto;left:auto;transform:none;margin:auto;width:85%;max-width:340px;padding:30px;background:rgba(15,15,15,.65);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-radius:0 40px 0 40px;border:1px solid rgba(255,255,255,.08);box-shadow:0 20px 60px rgba(0,0,0,.9);z-index:100;text-align:center;color:#fff;transition:all .6s cubic-bezier(.16,1,.3,1);overflow:hidden}body{height:100vh;display:flex;align-items:center;justify-content:center}#signup-container::before{content:'';position:absolute;background:#d40000;box-shadow:0 0 15px 2px rgba(212,0,0,.6);z-index:0;top:0;left:0;width:4px;height:100%}@keyframes orbit-to-right{0%{left:0;top:0;width:4px;height:100%}30%{left:0;top:0;width:4px;height:4px}50%{left:0;top:0;width:100%;height:4px}70%{left:calc(100% - 4px);top:0;width:4px;height:4px}100%{left:calc(100% - 4px);top:0;width:4px;height:100%}}@keyframes orbit-to-left{0%{left:calc(100% - 4px);top:0;width:4px;height:100%}30%{left:calc(100% - 4px);top:0;width:4px;height:4px}50%{left:0;top:0;width:100%;height:4px}70%{left:0;top:0;width:4px;height:4px}100%{left:0;top:0;width:4px;height:100%}}#signup-container.login-mode{border-radius:40px 0 40px 0}#signup-container.login-mode::before{animation:orbit-to-right .6s cubic-bezier(.45,0,.55,1) forwards}#signup-container.initialized:not(.login-mode)::before{animation:orbit-to-left .6s cubic-bezier(.45,0,.55,1) forwards}#signup-container h2{margin:0 0 8px;font-weight:300;letter-spacing:3px;text-transform:uppercase;font-size:22px;color:#fff}#signup-container p{color:#888;font-size:11px;margin-bottom:25px;letter-spacing:1px;text-transform:uppercase;transition:opacity .3s ease,transform .3s ease;opacity:1;transform:translateY(0)}.input-group{position:relative;margin-bottom:20px;text-align:left;overflow:hidden;max-height:80px;opacity:1;transform:translateY(0) scale(1);filter:blur(0);transform-origin:top center;transition:all .5s cubic-bezier(.16,1,.3,1)}.input-group.collapsed{max-height:0;margin-bottom:0;opacity:0;transform:translateY(-20px) scale(.95);filter:blur(10px);pointer-events:none}.input-group input{width:100%;padding:12px 0;font-size:16px;color:#fff;background:0 0;border:none;border-bottom:1px solid #444;outline:0;transition:border-color .3s;font-family:inherit}.input-group input:focus{border-bottom:1px solid #ff0000}.input-group label{position:absolute;top:12px;left:0;color:#666;font-size:14px;pointer-events:none;transition:.3s ease all;text-transform:uppercase;letter-spacing:1px}.input-group input:focus~label,.input-group input:not(:placeholder-shown)~label{top:-12px;font-size:10px;color:#ff0000;font-weight:600}.options-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;font-size:12px;color:#888;max-height:40px;opacity:1;transform:translateY(0);transition:all .5s cubic-bezier(.16,1,.3,1);overflow:hidden}.options-row.collapsed{max-height:0;margin-bottom:0;opacity:0;transform:translateY(-10px);pointer-events:none}.remember-me{display:flex;align-items:center;cursor:pointer;user-select:none;transition:color .3s}.remember-me:hover{color:#ccc}.remember-me input{position:absolute;opacity:0;cursor:pointer;height:0;width:0}.checkmark{height:14px;width:14px;background-color:transparent;border:1px solid #666;margin-right:8px;position:relative;transition:all .3s}.remember-me:hover input~.checkmark{border-color:#999}.remember-me input:checked~.checkmark{background-color:#d40000;border-color:#d40000}.checkmark:after{content:"";position:absolute;display:none;left:4px;top:1px;width:3px;height:7px;border:solid #fff;border-width:0 2px 2px 0;transform:rotate(45deg)}.remember-me input:checked~.checkmark:after{display:block}.forgot-password{color:#888;text-decoration:none;transition:color .3s;padding:5px 0}.forgot-password:hover{color:#fff;text-decoration:underline}button.submit-btn{width:100%;padding:16px;background:linear-gradient(135deg,#4a0000,#220000);color:#aaa;border:none;border-radius:0 20px 0 20px;cursor:not-allowed;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:2px;margin-top:5px;transition:all .6s cubic-bezier(.16,1,.3,1);box-shadow:0 4px 10px rgba(0,0,0,.3);opacity:.7;-webkit-touch-callout:none}#signup-container.login-mode button.submit-btn{border-radius:20px 0 20px 0}button.submit-btn.valid{cursor:pointer;opacity:1;color:#fff;background:linear-gradient(135deg,#ff1a1a,#cc0000);box-shadow:0 0 20px rgba(255,0,0,.6);animation:heartbeat 2s infinite ease-in-out;letter-spacing:3px}@keyframes heartbeat{0%{box-shadow:0 0 15px rgba(255,0,0,.5);transform:scale(1)}50%{box-shadow:0 0 30px rgba(255,50,50,.8);transform:scale(1.02)}100%{box-shadow:0 0 15px rgba(255,0,0,.5);transform:scale(1)}}button.submit-btn.valid:active{transform:scale(.98);animation:none}@media (hover:hover){button.submit-btn.valid:hover{transform:translateY(-2px);background:linear-gradient(135deg,#ff3333,#e60000)}}.footer-link{display:block;margin-top:20px;font-size:12px;color:#555;text-decoration:none;cursor:pointer;transition:color .2s,opacity .3s ease,transform .3s ease;opacity:1;transform:translateY(0);padding:10px}.footer-link:hover{color:#888}@media (max-width:480px){#signup-container{padding:25px}#signup-container h2{font-size:20px}}@keyframes shake{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-5px)}20%,40%,60%,80%{transform:translateX(5px)}}.shake{animation:shake .4s cubic-bezier(.36,.07,.19,.97) both}</style><script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js","three/addons/":"https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"}}<\/script></head><body><div id="signup-container"><h2 id="form-title">P Zero World</h2><p id="form-subtitle">Access the telemetry</p><form onsubmit="event.preventDefault()"><div class="input-group" id="racer-id-group"><input type="text" id="racer-id-input" placeholder=" " required><label>Racer ID</label></div><div class="input-group" id="email-group"><input type="email" id="email-input" placeholder=" " required><label>Email Address</label></div><div class="input-group" id="password-group"><input type="password" id="password-input" placeholder=" " required><label>Access Code</label></div><div class="options-row collapsed" id="login-options"><label class="remember-me"><input type="checkbox"><span class="checkmark"></span> Remember me </label><a href="#" class="forgot-password" id="forgot-pw-link">Forgot password?</a></div><button class="submit-btn" id="submit-btn">Initialize Session</button></form><a class="footer-link" id="auth-toggle">Already have an account? Log in</a></div><div id="error-toast" style="position:absolute;top:20px;left:50%;transform:translateX(-50%) translateY(-20px);opacity:0;background:rgba(220,38,38,0.9);color:white;padding:10px 20px;border-radius:4px;font-size:12px;font-weight:600;pointer-events:none;transition:all 0.3s ease;z-index:200;backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,0.1);text-transform:uppercase;letter-spacing:1px;box-shadow:0 4px 20px rgba(0,0,0,0.5)"></div><script type="module">import*as THREE from'three';import{OrbitControls}from'three/addons/controls/OrbitControls.js';const authToggleBtn=document.getElementById('auth-toggle'),signupContainer=document.getElementById('signup-container'),racerIdGroup=document.getElementById('racer-id-group'),emailGroup=document.getElementById('email-group'),passwordGroup=document.getElementById('password-group'),racerIdInput=document.getElementById('racer-id-input'),emailInput=document.getElementById('email-input'),passwordInput=document.getElementById('password-input'),loginOptions=document.getElementById('login-options'),forgotPwLink=document.getElementById('forgot-pw-link'),submitBtn=document.getElementById('submit-btn'),formTitle=document.getElementById('form-title'),formSubtitle=document.getElementById('form-subtitle'),errorToast=document.getElementById('error-toast');let currentMode='signup',isAnimating=!1;const emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;function checkValidity(){let e=!1;const t=racerIdInput.value.trim(),n=emailInput.value.trim(),o=passwordInput.value,i=emailRegex.test(n);'signup'===currentMode?e=t.length>0&&i&&o.length>0:'login'===currentMode?e=t.length>0&&o.length>0:'forgot'===currentMode&&(e=i),e?submitBtn.classList.add('valid'):submitBtn.classList.remove('valid')}[racerIdInput,emailInput,passwordInput].forEach(e=>{e.addEventListener('input',checkValidity)});async function setMode(e){if(isAnimating||currentMode===e)return;isAnimating=!0,currentMode=e,submitBtn.classList.remove('valid'),signupContainer.classList.contains('initialized')||signupContainer.classList.add('initialized'),'signup'===e?signupContainer.classList.remove('login-mode'):signupContainer.classList.add('login-mode');const t=[formTitle,formSubtitle,submitBtn,authToggleBtn];t.forEach(e=>{e.style.opacity='0',e.style.transform='translateY(5px)'}),await new Promise(e=>setTimeout(e,300)),'signup'===e?(racerIdGroup.classList.remove('collapsed'),emailGroup.classList.remove('collapsed'),passwordGroup.classList.remove('collapsed'),loginOptions.classList.add('collapsed'),racerIdInput.setAttribute('required','true'),emailInput.setAttribute('required','true'),passwordInput.setAttribute('required','true'),formTitle.textContent='P Zero World',formSubtitle.textContent='Access the telemetry',submitBtn.textContent='Initialize Session',authToggleBtn.textContent='Already have an account? Log in'):'login'===e?(racerIdGroup.classList.remove('collapsed'),passwordGroup.classList.remove('collapsed'),loginOptions.classList.remove('collapsed'),emailGroup.classList.add('collapsed'),racerIdInput.setAttribute('required','true'),passwordInput.setAttribute('required','true'),setTimeout(()=>emailInput.removeAttribute('required'),100),formTitle.textContent='P Zero World',formSubtitle.textContent='Resume Telemetry',submitBtn.textContent='Enter Paddock',authToggleBtn.textContent='New racer? Sign up'):'forgot'===e&&(emailGroup.classList.remove('collapsed'),racerIdGroup.classList.add('collapsed'),passwordGroup.classList.add('collapsed'),loginOptions.classList.add('collapsed'),emailInput.setAttribute('required','true'),racerIdInput.removeAttribute('required'),passwordInput.removeAttribute('required'),formTitle.textContent='Account Recovery',formSubtitle.textContent='Enter email to reset password',submitBtn.textContent='Send Reset Link',authToggleBtn.textContent='Back to Log In'),checkValidity(),t.forEach(e=>{e.style.opacity='1',e.style.transform='translateY(0)'}),setTimeout(()=>{isAnimating=!1},500)}authToggleBtn.addEventListener('click',e=>{e.preventDefault(),'signup'===currentMode?setMode('login'):'login'===currentMode?setMode('signup'):'forgot'===currentMode&&setMode('login')}),forgotPwLink.addEventListener('click',e=>{e.preventDefault(),setMode('forgot')});function showError(msg){errorToast.textContent=msg;errorToast.style.opacity='1';errorToast.style.transform='translateX(-50%) translateY(0)';setTimeout(()=>{errorToast.style.opacity='0';errorToast.style.transform='translateX(-50%) translateY(-20px)'},3000)}submitBtn.addEventListener('click',async(e)=>{e.preventDefault();if(!submitBtn.classList.contains('valid')){submitBtn.classList.add('shake');setTimeout(()=>submitBtn.classList.remove('shake'),500);if('signup'===currentMode){if(!racerIdInput.value)return showError("RACER ID REQUIRED");if(!emailInput.value||!emailRegex.test(emailInput.value))return showError("VALID EMAIL REQUIRED");if(!passwordInput.value)return showError("ACCESS CODE REQUIRED")}else if('login'===currentMode){if(!racerIdInput.value)return showError("RACER ID REQUIRED");if(!passwordInput.value)return showError("ACCESS CODE REQUIRED")}else if('forgot'===currentMode&&(!emailInput.value||!emailRegex.test(emailInput.value)))return showError("VALID EMAIL REQUIRED");return}const email=emailInput.value;const pass=passwordInput.value;const racerId=racerIdInput.value;const originalText=submitBtn.textContent;submitBtn.textContent="AUTHENTICATING...";submitBtn.style.opacity="0.7";submitBtn.style.cursor="wait";try{await window.parent.velocityAuth.authenticate(email,pass,currentMode,racerId)}catch(err){showError(err.message);submitBtn.textContent="ACCESS DENIED";submitBtn.style.background="linear-gradient(135deg, #ff0000, #990000)";setTimeout(()=>{submitBtn.textContent=originalText;submitBtn.style.opacity="1";submitBtn.style.cursor="pointer";submitBtn.style.background=""},2000)}});const CONFIG={tireRadius:10,tireTube:3.5,rimRadius:5.8,rimWidth:5,spokeCount:7,brakeDiscRadius:4.5},scene=new THREE.Scene;scene.background=new THREE.Color(0x050505),scene.fog=new THREE.FogExp2(0x050505,.015);const camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1000);function updateCameraPosition(){const e=window.innerWidth/window.innerHeight;e<.8?camera.position.set(0,2,65):camera.position.set(0,2,45),camera.lookAt(0,0,0)}updateCameraPosition();const renderer=new THREE.WebGLRenderer({antialias:window.devicePixelRatio<2});renderer.setSize(window.innerWidth,window.innerHeight),renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap,document.body.appendChild(renderer.domElement);const controls=new OrbitControls(camera,renderer.domElement);function createBrakeDiscTexture(){const e=document.createElement('canvas');e.width=512,e.height=512;const t=e.getContext('2d');t.fillStyle='#FFFFFF',t.fillRect(0,0,512,512),t.fillStyle='#000000';const r=256,o=256;for(let e=100;e<230;e+=25){const a=2*Math.PI*e,n=Math.floor(a/20);for(let a=0;a<n;a++){const n=a/n*Math.PI*2,i=e+(5*Math.random()-2.5),s=r+Math.cos(n)*i,l=o+Math.sin(n)*i;t.beginPath(),t.arc(s,l,4,0,2*Math.PI),t.fill()}}t.strokeStyle='rgba(0,0,0,0.1)',t.lineWidth=1;for(let e=0;e<10;e++)t.beginPath(),t.arc(r,o,100+130*Math.random(),0,2*Math.PI),t.stroke();const a=new THREE.CanvasTexture(e);return a.anisotropy=4,a}function createTireTexture(){const e=document.createElement('canvas');e.width=512,e.height=512;const t=e.getContext('2d');t.fillStyle='#111111',t.fillRect(0,0,512,512);for(let e=0;e<5e3;e++)t.fillStyle=\`rgba(255,255,255,\${.05*Math.random()})\`,t.fillRect(512*Math.random(),512*Math.random(),2,2);t.save(),t.translate(256,256);function r(e,r,o,a,n,i=.15,s='Arial'){t.font=\`900 \${n}px \${s}\`,t.fillStyle=a,t.textAlign='center',t.textBaseline='middle';const l=e.length*i;let c=o-l/2;e.split('').forEach(e=>{t.save(),t.rotate(c),t.translate(0,-r),t.fillText(e,0,0),t.restore(),c+=i})}r("P ZERO",175,0,"#D40000",45,.18),r("SOFT",175,Math.PI,"#ffffff",30,.12),t.rotate(Math.PI/4),t.fillStyle='#FFFFFF',t.fillRect(-30,-140,60,15),t.strokeStyle="rgba(255,255,255,0.1)",t.lineWidth=2,t.beginPath(),t.arc(0,0,190,0,1.5),t.stroke(),t.restore();const o=new THREE.CanvasTexture(e);return o.anisotropy=4,o}controls.enableDamping=!0,controls.dampingFactor=.05,controls.minDistance=10,controls.maxDistance=80,controls.enablePan=!1,controls.enableZoom=!1;const rubberMaterial=new THREE.MeshStandardMaterial({color:0x1a1a1a,roughness:.6,metalness:.1,map:createTireTexture(),bumpMap:createTireTexture(),bumpScale:.02}),slickMaterial=new THREE.MeshStandardMaterial({color:0x151515,roughness:.7,metalness:0}),rimMaterial=new THREE.MeshStandardMaterial({color:0x080808,roughness:.3,metalness:.9}),rimStripeMaterial=new THREE.MeshStandardMaterial({color:0xff0000,emissive:0xaa0000,emissiveIntensity:.8,roughness:.2,metalness:.5}),brakeDiscMap=createBrakeDiscTexture(),brakeDiscMaterial=new THREE.MeshStandardMaterial({color:0xdddddd,map:brakeDiscMap,alphaMap:brakeDiscMap,transparent:!0,side:THREE.DoubleSide,roughness:.4,metalness:.8}),hubMaterial=new THREE.MeshStandardMaterial({color:0x222222,roughness:.5,metalness:.7}),axleMaterial=new THREE.MeshStandardMaterial({color:0x444444,roughness:.3,metalness:.8}),wheelAssembly=new THREE.Group;scene.add(wheelAssembly);const rotatingGroup=new THREE.Group;wheelAssembly.add(rotatingGroup);const axleGeo=new THREE.CylinderGeometry(.5,.5,7,12);axleGeo.rotateX(Math.PI/2);const axle=new THREE.Mesh(axleGeo,axleMaterial);wheelAssembly.add(axle);const tireGeo=new THREE.TorusGeometry(CONFIG.tireRadius,CONFIG.tireTube,24,48),tire=new THREE.Mesh(tireGeo,rubberMaterial);tire.scale.set(1,1,1.8),tire.castShadow=!0;const sidewallGeo=new THREE.RingGeometry(CONFIG.rimRadius,CONFIG.tireRadius+CONFIG.tireTube/2,48),sidewallLeft=new THREE.Mesh(sidewallGeo,rubberMaterial);sidewallLeft.position.z=2.5,sidewallLeft.rotation.y=Math.PI;const sidewallRight=new THREE.Mesh(sidewallGeo,rubberMaterial);sidewallRight.position.z=-2.5;const slickGeo=new THREE.CylinderGeometry(CONFIG.tireRadius+CONFIG.tireTube-.2,CONFIG.tireRadius+CONFIG.tireTube-.2,5,48,1,!0);slickGeo.rotateX(Math.PI/2);const slick=new THREE.Mesh(slickGeo,slickMaterial);slick.castShadow=!0;const edgeGeo=new THREE.TorusGeometry(CONFIG.tireRadius+1.5,1.8,12,48),edgeMesh=new THREE.Mesh(edgeGeo,slickMaterial);edgeMesh.scale.set(1,1,1.4),rotatingGroup.add(sidewallLeft),rotatingGroup.add(sidewallRight),rotatingGroup.add(slick),rotatingGroup.add(edgeMesh);const rimCylGeo=new THREE.CylinderGeometry(CONFIG.rimRadius,CONFIG.rimRadius,CONFIG.rimWidth,48,1,!0);rimCylGeo.rotateX(Math.PI/2);const rim=new THREE.Mesh(rimCylGeo,rimMaterial);rotatingGroup.add(rim);const rimLipGeo=new THREE.TorusGeometry(CONFIG.rimRadius-.1,.2,8,48),rimLip1=new THREE.Mesh(rimLipGeo,rimMaterial);rimLip1.position.z=CONFIG.rimWidth/2;const rimLip2=rimLip1.clone();rimLip2.position.z=-CONFIG.rimWidth/2,rotatingGroup.add(rimLip1),rotatingGroup.add(rimLip2);const rimStripeGeo=new THREE.TorusGeometry(CONFIG.rimRadius-.05,.05,8,64),rimStripe1=new THREE.Mesh(rimStripeGeo,rimStripeMaterial);rimStripe1.position.z=CONFIG.rimWidth/2+.1;const rimStripe2=rimStripe1.clone();rimStripe2.position.z=-CONFIG.rimWidth/2-.1,rotatingGroup.add(rimStripe1),rotatingGroup.add(rimStripe2);const spokeGroup=new THREE.Group,spokeGeo=new THREE.CylinderGeometry(.5,.3,CONFIG.rimRadius-1.5,6),spokeLen=CONFIG.rimRadius-1.5,dist=1.5+spokeLen/2;for(let e=0;e<CONFIG.spokeCount;e++){const t=e/CONFIG.spokeCount*Math.PI*2,r=new THREE.Mesh(spokeGeo,rimMaterial);r.position.x=Math.cos(t)*dist,r.position.y=Math.sin(t)*dist,r.rotation.z=t-Math.PI/2,spokeGroup.add(r)}rotatingGroup.add(spokeGroup);const hubGeo=new THREE.CylinderGeometry(1.6,1.6,6,24);hubGeo.rotateX(Math.PI/2);const hub=new THREE.Mesh(hubGeo,hubMaterial);rotatingGroup.add(hub);const discGeo=new THREE.RingGeometry(2.5,CONFIG.brakeDiscRadius,48),disc=new THREE.Mesh(discGeo,brakeDiscMaterial);disc.position.z=1.8,disc.castShadow=!0;const discBack=disc.clone();discBack.rotation.y=Math.PI,discBack.position.z=1.9;const carrierGeo=new THREE.RingGeometry(1.5,2.5,24),carrierMat=new THREE.MeshStandardMaterial({color:0x111111,metalness:.8,roughness:.5}),carrier=new THREE.Mesh(carrierGeo,carrierMat);carrier.position.z=1.85,carrier.receiveShadow=!0;const boltGeo=new THREE.CylinderGeometry(.12,.12,.25,6),boltMat=new THREE.MeshStandardMaterial({color:0x888888,metalness:1,roughness:.2});for(let e=0;e<5;e++){const t=e/5*Math.PI*2,r=new THREE.Mesh(boltGeo,boltMat);r.rotateX(Math.PI/2),r.position.set(2.5*Math.cos(t),2.5*Math.sin(t),1.95),rotatingGroup.add(r)}rotatingGroup.add(disc),rotatingGroup.add(discBack),rotatingGroup.add(carrier);const ambientLight=new THREE.AmbientLight(0xffffff,.2);scene.add(ambientLight);const spotLight=new THREE.SpotLight(0xffffff,400);spotLight.position.set(-10,30,20),spotLight.angle=Math.PI/6,spotLight.penumbra=.3,spotLight.castShadow=!0,spotLight.shadow.mapSize.width=512,spotLight.shadow.mapSize.height=512,scene.add(spotLight);const rimLight1=new THREE.PointLight(0x4444ff,100);rimLight1.position.set(20,10,10),scene.add(rimLight1);const rimLight2=new THREE.PointLight(0xff4444,100);rimLight2.position.set(-20,10,-10),scene.add(rimLight2);const planeGeo=new THREE.PlaneGeometry(500,500),planeMat=new THREE.MeshStandardMaterial({color:0x050505,roughness:.1,metalness:.5}),plane=new THREE.Mesh(planeGeo,planeMat);plane.rotation.x=-Math.PI/2,plane.position.y=-(CONFIG.tireRadius+CONFIG.tireTube+.5),plane.receiveShadow=!0,scene.add(plane);const clock=new THREE.Clock,pathLength=80,outerRadius=CONFIG.tireRadius+CONFIG.tireTube;function animate(){requestAnimationFrame(animate);const e=clock.getElapsedTime(),t=15,r=e*t%pathLength;wheelAssembly.position.x=r-pathLength/2,wheelAssembly.rotation.y=.02*Math.sin(8*e),wheelAssembly.rotation.z=.01*Math.cos(5*e),rotatingGroup.rotation.z=-wheelAssembly.position.x/outerRadius;const o=wheelAssembly.position.x,a=new THREE.Vector3(o,0,0);controls.target.lerp(a,.1),controls.update(),renderer.render(scene,camera)}window.addEventListener('resize',()=>{updateCameraPosition(),camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}),animate();<\/script></body></html>`;

        const WHEEL_CONFIG = {
            tireRadius: 2.5,
            tireTube: 0.8,
            rimRadius: 1.5,
            rimWidth: 0.5,
            spokeCount: 7,
            brakeDiscRadius: 1.2,
            scaleFactor: 0.8
        };

        const pagesContent = {
            concept: { title: "CONCEPT // ZERO", content: "" },
            engineering: { title: "ENGINEERING // CORE", content: "Built on a custom WebGL render pipeline, Velocity.OS achieves 60fps interaction on standard hardware. <br><br><b>Stack:</b><br>- Three.js (Custom Shaders)<br>- React Fiber (Orchestration)<br>- Rust (WASM Modules for Physics)<br><br>Every animation is calculated in real-time. No pre-rendered videos. Pure math." },
            // Configure content is now handled dynamically by renderAdminDashboard()
            configure: { title: "COMMAND // CONSOLE", content: "" },
            login: {
                title: "ACCESS CONTROL",
                content: "" // Content handled by LOGIN_HTML via iframe injection
            }
        };

        const IDLE_ROTATION_SPEED = 0.001;
        const scrollRotationSpeed = 0.005;
        const SMOOTHING_FACTOR = 0.1;
        const MAX_SCROLL_AMOUNT = 7000;

        const AMBIENT_COLOR = 0x111111;
        const SPOTLIGHT_COLOR = 0x880000;
        const GROUND_COLOR = 0x010101;
        const SPHERE_COLOR_START = new THREE.Color(0xaa0000);
        const SPHERE_COLOR_END = new THREE.Color(0xffffff);

        const TOP_SPHERE_Y = 0.75;
        const KEYBOARD_Y = -4.0;
        const WHEEL_Y = -12.0;
        const LOWEST_TARGET_Y = WHEEL_Y;
        const KEYBOARD_X_POSITION = 0.5;
        const CAMERA_Z_START = 5.0;
        const CAMERA_Z_END = 3.5;

        // --- MARKETPLACE DATA ---
        // Helper to generate random stats for demo purposes
        const randomStats = () => ({
            views: Math.floor(Math.random() * 5000) + 500,
            downloads: Math.floor(Math.random() * 1000) + 50,
            rating: (Math.random() * (5.0 - 4.0) + 4.0).toFixed(1),
            createdAt: Date.now() - Math.floor(Math.random() * 10000000000) // Random time in past ~4 months
        });

        let products = {
            trending: [
                { id: "t1", title: "VELOCITY_MOTION", cat: "HERO", price: "$99", img: "https://images.unsplash.com/photo-1550745165-9bc0b252726f?auto=format&fit=crop&w=600&q=80", desc: "Production-grade animation primitives for React. Includes spring physics, orchestrated timelines, and gesture support.", ...randomStats() },
                { id: "t2", title: "GLASS_UI_KIT", cat: "SECTION", price: "$49", img: "https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?auto=format&fit=crop&w=600&q=80", desc: "Frosted glass morphism component library. Features 50+ pre-built components.", ...randomStats() },
                { id: "t3", title: "GRID_SYSTEM_PRO", cat: "SECTION", price: "$29", img: "https://images.unsplash.com/photo-1558655146-d09347e0b7a9?auto=format&fit=crop&w=600&q=80", desc: "Responsive, sub-grid compatible layout engine.", ...randomStats() },
                { id: "t4", title: "CHART_WRAPPER", cat: "FEATURE", price: "$35", img: "https://images.unsplash.com/photo-1551288049-bebda4e38f71?auto=format&fit=crop&w=600&q=80", desc: "Canvas-accelerated financial charting suite.", ...randomStats() },
                { id: "t5", title: "NEON_BUTTONS", cat: "BUTTON", price: "$15", img: "https://images.unsplash.com/photo-1563089145-599997674d42?auto=format&fit=crop&w=600&q=80", desc: "Glow-effect interactive button set.", ...randomStats() },
                { id: "t6", title: "DARK_MODE_THEME", cat: "BACKGROUND", price: "$25", img: "https://images.unsplash.com/photo-1555421689-d68471e189f2?auto=format&fit=crop&w=600&q=80", desc: "Optimized OLED-black color palettes.", ...randomStats() },
                { id: "t7", title: "THREE_FIBER_STARTER", cat: "HERO", price: "FREE", img: "https://images.unsplash.com/photo-1614854262318-831574f15f1f?auto=format&fit=crop&w=600&q=80", desc: "Boilerplate for WebGL experiences.", ...randomStats() },
                { id: "t8", title: "AUTH_MODAL_PACK", cat: "FORM", price: "$20", img: "https://images.unsplash.com/photo-1614064641938-3e821efd8536?auto=format&fit=crop&w=600&q=80", desc: "Secure, accessible login/signup flows.", ...randomStats() }
            ],
            new: [
                { id: "n1", title: "3D_MODEL_VIEWER", cat: "FEATURE", price: "$59", img: "https://images.unsplash.com/photo-1633356122544-f134324a6cee?auto=format&fit=crop&w=600&q=80", desc: "Drag-and-drop GLTF/OBJ viewer component.", ...randomStats() },
                { id: "n2", title: "AUDIO_VISUALIZER", cat: "FEATURE", price: "$45", img: "https://images.unsplash.com/photo-1470225620780-dba8ba36b745?auto=format&fit=crop&w=600&q=80", desc: "Real-time frequency analysis canvas.", ...randomStats() },
                { id: "n3", title: "HAPTIC_FEEDBACK", cat: "BUTTON", price: "$30", img: "https://images.unsplash.com/photo-1621360841013-c768371e93cf?auto=format&fit=crop&w=600&q=80", desc: "Vibration API patterns for mobile web.", ...randomStats() },
                { id: "n4", title: "PAYMENT_MODAL", cat: "PRICING", price: "$40", img: "https://images.unsplash.com/photo-1556742049-0cfed4f7a07d?auto=format&fit=crop&w=600&q=80", desc: "Stripe-integrated checkout overlay.", ...randomStats() },
                { id: "n5", title: "CONFETTI_CANNON", cat: "BACKGROUND", price: "$10", img: "https://images.unsplash.com/photo-1514525253440-b393452e8d26?auto=format&fit=crop&w=600&q=80", desc: "High-performance particle celebration.", ...randomStats() },
                { id: "n6", title: "SCROLL_SNAP_PRO", cat: "SECTION", price: "$25", img: "https://images.unsplash.com/photo-1507721999472-8ed4421c4af2?auto=format&fit=crop&w=600&q=80", desc: "Smoothed scroll-snapping logic.", ...randomStats() },
                { id: "n7", title: "DATE_PICKER_X", cat: "FORM", price: "$20", img: "https://images.unsplash.com/photo-1506784983877-45594efa4cbe?auto=format&fit=crop&w=600&q=80", desc: "Accessible, keyboard-navigable calendar.", ...randomStats() },
                { id: "n8", title: "TOAST_NOTIFY", cat: "HEADER", price: "$15", img: "https://images.unsplash.com/photo-1596526131083-e8c633c948d2?auto=format&fit=crop&w=600&q=80", desc: "Stackable notification system.", ...randomStats() }
            ],
            community: [
                { id: "c1", title: "REACT_SPRING_FORK", cat: "HERO", price: "FREE", img: "https://images.unsplash.com/photo-1550751827-4bd374c3f58b?auto=format&fit=crop&w=600&q=80", desc: "Community maintained physics spring lib.", ...randomStats() },
                { id: "c2", title: "VUE_ADAPTER", cat: "FEATURE", price: "FREE", img: "https://images.unsplash.com/photo-1515879218367-8466d910aaa4?auto=format&fit=crop&w=600&q=80", desc: "Use Velocity components in Vue apps.", ...randomStats() },
                { id: "c3", title: "SVELTE_TRANSITIONS", cat: "HERO", price: "FREE", img: "https://images.unsplash.com/photo-1550439062-609e1531270e?auto=format&fit=crop&w=600&q=80", desc: "Port of core transitions to Svelte.", ...randomStats() },
                { id: "c4", title: "FIGMA_DESIGN_SYSTEM", cat: "CARD", price: "$20", img: "https://images.unsplash.com/photo-1561070791-2526d30994b5?auto=format&fit=crop&w=600&q=80", desc: "Complete UI kit for Figma.", ...randomStats() },
                { id: "c5", title: "VSCODE_THEME", cat: "BACKGROUND", price: "FREE", img: "https://images.unsplash.com/photo-1542831371-29b0f74f9713?auto=format&fit=crop&w=600&q=80", desc: "Velocity OS syntax highlighting.", ...randomStats() },
                { id: "c6", title: "CLI_TOOL", cat: "FEATURE", price: "FREE", img: "https://images.unsplash.com/photo-1629654297299-c8506221ca97?auto=format&fit=crop&w=600&q=80", desc: "Scaffold projects from the terminal.", ...randomStats() },
                { id: "c7", title: "ICON_PACK_V2", cat: "LOGO", price: "$10", img: "https://images.unsplash.com/photo-1611162617474-5b21e879e113?auto=format&fit=crop&w=600&q=80", desc: "200+ SVG vector icons.", ...randomStats() },
                { id: "c8", title: "DOCS_TEMPLATE", cat: "HEADING", price: "$25", img: "https://images.unsplash.com/photo-1555421689-491a97ff2040?auto=format&fit=crop&w=600&q=80", desc: "Markdown-driven documentation site.", ...randomStats() }
            ]
        };

        // --- STORE & AUTH SYSTEM (Dynamic Components) ---
        window.velocityStore = {
            products: products,
            adminFilter: {
                search: '',
                category: 'ALL',
                sort: 'NEWEST'
            },
            addComponent: function (data) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const newProduct = {
                            id: "u" + Date.now(),
                            title: data.title,
                            cat: data.cat,
                            price: data.price,
                            img: data.img,
                            desc: data.desc,
                            lang: data.lang,
                            code: data.code,
                            // Analytics Initial State
                            views: 0,
                            downloads: 0,
                            rating: "5.0",
                            createdAt: Date.now()
                        };
                        // Add to New and Community lists
                        this.products.new.unshift(newProduct);
                        this.products.community.unshift(newProduct);

                        // If current tab is New or Community, re-render immediately
                        if (currentTab === 'new' || currentTab === 'community') {
                            renderCards();
                        }
                        resolve(newProduct);
                    }, 500);
                });
            },
            updateComponent: function (id, data) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        // Update in all categories
                        Object.keys(this.products).forEach(key => {
                            this.products[key] = this.products[key].map(p => {
                                if (p.id === id) {
                                    return { ...p, ...data, id: id }; // Keep original ID
                                }
                                return p;
                            });
                        });
                        renderCards(); // Refresh marketplace
                        resolve();
                    }, 500);
                });
            },
            deleteComponent: function (id) {
                // Remove from all arrays
                Object.keys(this.products).forEach(key => {
                    this.products[key] = this.products[key].filter(p => p.id !== id);
                });
                renderCards(); // Refresh marketplace
            },
            getComponent: function (id) {
                // Helper to find a component
                for (const key of Object.keys(this.products)) {
                    const found = this.products[key].find(p => p.id === id);
                    if (found) return found;
                }
                return null;
            },
            getAllComponents: function () {
                // Flatten and dedupe for admin view
                const all = [];
                const seen = new Set();
                ['trending', 'new', 'community'].forEach(key => {
                    this.products[key].forEach(p => {
                        if (!seen.has(p.id)) {
                            all.push(p);
                            seen.add(p.id);
                        }
                    });
                });
                return all;
            },
            // Advanced Filtering for Admin
            getFilteredComponents: function () {
                let items = this.getAllComponents();
                const { search, category, sort } = this.adminFilter;

                if (category !== 'ALL') {
                    items = items.filter(i => i.cat === category);
                }
                if (search) {
                    const q = search.toLowerCase();
                    items = items.filter(i => i.title.toLowerCase().includes(q));
                }

                // Sorting
                items.sort((a, b) => {
                    if (sort === 'NEWEST') return b.createdAt - a.createdAt;
                    if (sort === 'OLDEST') return a.createdAt - b.createdAt;
                    if (sort === 'POPULAR') return b.views - a.views;
                    if (sort === 'RATING') return b.rating - a.rating;
                    return 0;
                });

                return items;
            }
        };

        // --- ADMIN DASHBOARD RENDERER ---
        function renderAdminDashboard() {
            const container = document.getElementById('page-overlay-body');
            const allItems = window.velocityStore.getFilteredComponents();
            const totalStats = window.velocityStore.getAllComponents().reduce((acc, curr) => {
                acc.views += (curr.views || 0);
                acc.downloads += (curr.downloads || 0);
                return acc;
            }, { views: 0, downloads: 0 });

            // Format numbers helper
            const kFormatter = (num) => Math.abs(num) > 999 ? Math.sign(num) * ((Math.abs(num) / 1000).toFixed(1)) + 'k' : Math.sign(num) * Math.abs(num);

            container.innerHTML = `
                <div class="flex flex-col gap-6 w-full font-['Inter']">
                    
                    <!-- Stats Overview -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-2">
                        <div class="bg-white/5 border border-white/10 p-4 rounded-sm">
                            <div class="text-[10px] text-gray-500 font-['Michroma'] tracking-widest mb-1">TOTAL ASSETS</div>
                            <div class="text-2xl text-white font-['Rajdhani'] font-bold">${window.velocityStore.getAllComponents().length}</div>
                        </div>
                        <div class="bg-white/5 border border-white/10 p-4 rounded-sm">
                            <div class="text-[10px] text-gray-500 font-['Michroma'] tracking-widest mb-1">TOTAL VIEWS</div>
                            <div class="text-2xl text-white font-['Rajdhani'] font-bold">${kFormatter(totalStats.views)}</div>
                        </div>
                        <div class="bg-white/5 border border-white/10 p-4 rounded-sm">
                            <div class="text-[10px] text-gray-500 font-['Michroma'] tracking-widest mb-1">DOWNLOADS</div>
                            <div class="text-2xl text-white font-['Rajdhani'] font-bold">${kFormatter(totalStats.downloads)}</div>
                        </div>
                        <div class="bg-white/5 border border-white/10 p-4 rounded-sm">
                            <div class="text-[10px] text-gray-500 font-['Michroma'] tracking-widest mb-1">SYSTEM</div>
                            <div class="text-2xl text-green-500 font-['Rajdhani'] font-bold">ONLINE</div>
                        </div>
                    </div>

                    <!-- Filters Bar -->
                    <div class="flex flex-col md:flex-row gap-4 bg-black/40 border border-white/10 p-4 rounded-sm">
                        <input oninput="updateAdminFilter('search', this.value)" type="text" placeholder="SEARCH INVENTORY..." class="flex-grow bg-white/5 border border-white/10 text-white px-4 py-2 text-xs outline-none focus:border-red-500 transition-colors rounded-sm">
                        
                        <!-- Fixed Dropdown Styling -->
                        <select onchange="updateAdminFilter('category', this.value)" class="bg-white/5 border border-white/10 text-white px-4 py-2 text-xs outline-none focus:border-red-500 transition-colors uppercase cursor-pointer rounded-sm">
                            <option value="ALL" class="bg-black text-white">All Categories</option>
                            <option value="HERO" class="bg-black text-white">Hero</option>
                            <option value="SECTION" class="bg-black text-white">Section</option>
                            <option value="BUTTON" class="bg-black text-white">Button</option>
                            <option value="CARD" class="bg-black text-white">Card</option>
                            <option value="FEATURE" class="bg-black text-white">Feature</option>
                            <option value="FORM" class="bg-black text-white">Form</option>
                            <option value="HEADER" class="bg-black text-white">Header</option>
                            <option value="FOOTER" class="bg-black text-white">Footer</option>
                            <option value="PRICING" class="bg-black text-white">Pricing</option>
                            <option value="TESTIMONIAL" class="bg-black text-white">Testimonial</option>
                            <option value="GALLERY" class="bg-black text-white">Gallery</option>
                        </select>
                        
                        <!-- Fixed Dropdown Styling -->
                        <select onchange="updateAdminFilter('sort', this.value)" class="bg-white/5 border border-white/10 text-white px-4 py-2 text-xs outline-none focus:border-red-500 transition-colors uppercase cursor-pointer rounded-sm">
                            <option value="NEWEST" class="bg-black text-white">Newest First</option>
                            <option value="OLDEST" class="bg-black text-white">Oldest First</option>
                            <option value="POPULAR" class="bg-black text-white">Most Popular</option>
                            <option value="RATING" class="bg-black text-white">Top Rated</option>
                        </select>
                    </div>

                    <!-- Action Bar -->
                    <div class="flex justify-between items-center border-b border-white/10 pb-4">
                        <h3 class="font-['Michroma'] text-sm text-gray-400">INVENTORY MANAGEMENT</h3>
                        <button onclick="resetAdminForm(); toggleAdminForm(true)" class="px-4 py-2 bg-red-600 text-white text-xs font-['Michroma'] tracking-wider hover:bg-red-700 transition-colors rounded-sm flex items-center gap-2">
                            <span>+ FABRICATE NEW ASSET</span>
                        </button>
                    </div>

                    <!-- Add/Edit Form (Hidden) -->
                    <div id="admin-form-container" class="hidden bg-black/40 border border-white/10 p-6 rounded-sm mb-4 relative">
                         <!-- ... form content (same as before) ... -->
                         <div class="absolute top-0 left-0 w-1 h-full bg-red-600"></div>
                         <h4 id="form-header" class="text-xs font-['Michroma'] text-white mb-4">NEW COMPONENT PARAMETERS</h4>
                         <input type="hidden" id="edit-mode-id" value=""> 
                         
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="group"><label class="block text-[10px] text-gray-500 font-['Michroma'] mb-1">TITLE</label><input id="new-title" type="text" class="w-full bg-white/5 border border-white/10 text-white px-4 py-3 text-xs outline-none focus:border-red-500 transition-colors"></div>
                            <div class="group"><label class="block text-[10px] text-gray-500 font-['Michroma'] mb-1">CATEGORY</label><select id="new-cat" class="w-full bg-white/5 border border-white/10 text-white px-4 py-3 text-xs outline-none focus:border-red-500 transition-colors uppercase cursor-pointer"><option value="HERO" class="bg-black text-white">Hero</option><option value="SECTION" class="bg-black text-white">Section</option><option value="BUTTON" class="bg-black text-white">Button</option><option value="CARD" class="bg-black text-white">Card</option><option value="BACKGROUND" class="bg-black text-white">Background</option><option value="HEADER" class="bg-black text-white">Header</option><option value="FOOTER" class="bg-black text-white">Footer</option><option value="FORM" class="bg-black text-white">Form</option></select></div>
                            <div class="group"><label class="block text-[10px] text-gray-500 font-['Michroma'] mb-1">PRICE</label><input id="new-price" type="text" class="w-full bg-white/5 border border-white/10 text-white px-4 py-3 text-xs outline-none focus:border-red-500 transition-colors"></div>
                            <div class="group"><label class="block text-[10px] text-gray-500 font-['Michroma'] mb-1">LANG</label><select id="new-lang" class="w-full bg-white/5 border border-white/10 text-white px-4 py-3 text-xs outline-none focus:border-red-500 transition-colors uppercase cursor-pointer"><option value="HTML" class="bg-black text-white">HTML</option><option value="REACT" class="bg-black text-white">React</option><option value="VUE" class="bg-black text-white">Vue</option></select></div>
                            <div class="group md:col-span-2"><label class="block text-[10px] text-gray-500 font-['Michroma'] mb-1">IMAGE</label><div class="flex gap-2 mb-2"><label class="text-[10px] text-gray-400"><input type="radio" name="img-source" value="url" checked onchange="toggleImageInputMode()" class="accent-red-600"> URL</label><label class="text-[10px] text-gray-400"><input type="radio" name="img-source" value="file" onchange="toggleImageInputMode()" class="accent-red-600"> UPLOAD</label></div><input id="new-img" type="text" class="w-full bg-white/5 border border-white/10 text-white px-4 py-3 text-xs outline-none focus:border-red-500 transition-colors"><input id="new-img-file" type="file" accept="image/*" class="hidden w-full bg-white/5 border border-white/10 text-gray-400 px-4 py-2 text-xs outline-none focus:border-red-500 transition-colors"></div>
                            <div class="group md:col-span-2"><label class="block text-[10px] text-gray-500 font-['Michroma'] mb-1">DESC</label><textarea id="new-desc" class="w-full bg-white/5 border border-white/10 text-white px-4 py-3 text-xs outline-none focus:border-red-500 transition-colors h-24 resize-none"></textarea></div>
                            <div class="group md:col-span-2"><label class="block text-[10px] text-gray-500 font-['Michroma'] mb-1">CODE</label><textarea id="new-code" class="w-full bg-[#0a0a0a] border border-white/10 text-gray-300 px-4 py-3 text-xs font-mono outline-none focus:border-red-500 transition-colors h-32 resize-y custom-scrollbar"></textarea></div>
                         </div>
                         <div class="flex justify-end gap-3">
                            <button onclick="toggleAdminForm(false)" class="px-6 py-2 border border-white/20 text-white text-xs font-['Michroma'] hover:bg-white hover:text-black transition-colors">CANCEL</button>
                            <button id="form-submit-btn" onclick="handleComponentSubmit()" class="px-6 py-2 bg-white text-black text-xs font-['Michroma'] hover:bg-gray-200 transition-colors">DEPLOY</button>
                         </div>
                    </div>

                    <!-- Filtered Component List -->
                    <div class="flex flex-col gap-2 max-h-[50vh] overflow-y-auto pr-2 custom-scrollbar">
                        ${allItems.length === 0 ? '<div class="text-center py-8 text-gray-600 text-xs">NO ASSETS FOUND MATCHING FILTERS</div>' : ''}
                        ${allItems.map(item => `
                            <div class="flex flex-col sm:flex-row sm:items-center gap-4 bg-white/5 p-4 rounded-sm border border-white/5 hover:border-white/20 transition-all group">
                                <div class="flex items-center gap-4 flex-grow">
                                    <img src="${item.img}" class="w-16 h-12 object-cover bg-black rounded-sm border border-white/10">
                                    <div class="min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <h4 class="text-white font-['Rajdhani'] font-bold text-lg leading-none truncate">${item.title}</h4>
                                            <span class="text-[9px] font-['Michroma'] text-red-500 bg-red-500/10 px-1.5 py-0.5 rounded-sm">${item.cat}</span>
                                        </div>
                                        <div class="flex items-center gap-4 text-[10px] text-gray-500 font-mono">
                                            <span class="flex items-center gap-1" title="Views"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg> ${kFormatter(item.views || 0)}</span>
                                            <span class="flex items-center gap-1" title="Downloads"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> ${kFormatter(item.downloads || 0)}</span>
                                            <span class="flex items-center gap-1" title="Rating"><svg class="w-3 h-3 text-yellow-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg> ${item.rating || 'N/A'}</span>
                                            <span>${new Date(item.createdAt || Date.now()).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between sm:justify-end gap-6 w-full sm:w-auto mt-2 sm:mt-0 border-t sm:border-t-0 border-white/5 pt-2 sm:pt-0">
                                    <div class="text-white font-mono text-xs">${item.price}</div>
                                    <div class="flex items-center gap-1">
                                        <button onclick="editAsset('${item.id}')" class="text-gray-600 hover:text-white hover:bg-white/10 transition-colors p-2 rounded-sm" title="Edit">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                        </button>
                                        <button onclick="deleteAsset('${item.id}')" class="text-gray-600 hover:text-red-500 hover:bg-red-500/10 transition-colors p-2 rounded-sm" title="Delete">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Global function for filter updates
        window.updateAdminFilter = function (key, value) {
            window.velocityStore.adminFilter[key] = value;
            renderAdminDashboard(); // Trigger re-render of list part
        }

        // Toggle Image Input Mode
        window.toggleImageInputMode = function () {
            const mode = document.querySelector('input[name="img-source"]:checked').value;
            const urlInput = document.getElementById('new-img');
            const fileInput = document.getElementById('new-img-file');

            if (mode === 'file') {
                urlInput.classList.add('hidden');
                fileInput.classList.remove('hidden');
            } else {
                urlInput.classList.remove('hidden');
                fileInput.classList.add('hidden');
            }
        }

        window.toggleAdminForm = function (show) {
            const form = document.getElementById('admin-form-container');
            if (show) {
                form.classList.remove('hidden');
                form.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                form.classList.add('hidden');
                resetAdminForm(); // Clear on hide
            }
        }

        window.resetAdminForm = function () {
            document.getElementById('new-title').value = '';
            document.getElementById('new-cat').value = 'HERO';
            document.getElementById('new-price').value = '';
            document.getElementById('new-img').value = '';
            document.getElementById('new-img-file').value = '';
            document.getElementById('new-desc').value = '';

            // Reset new fields
            document.getElementById('new-lang').value = 'HTML';
            document.getElementById('new-code').value = '';

            document.getElementById('edit-mode-id').value = '';
            document.getElementById('form-header').textContent = "NEW COMPONENT PARAMETERS";
            document.getElementById('form-submit-btn').textContent = "DEPLOY";
            const radios = document.getElementsByName('img-source');
            if (radios.length) radios[0].checked = true;
            toggleImageInputMode();
        }

        window.editAsset = function (id) {
            const item = window.velocityStore.getComponent(id);
            if (!item) return;

            // Open Form
            toggleAdminForm(true);

            // Populate Fields
            document.getElementById('new-title').value = item.title;

            const selectCat = document.getElementById('new-cat');
            const catUpper = item.cat.toUpperCase();
            let catFound = false;
            for (let i = 0; i < selectCat.options.length; i++) {
                if (selectCat.options[i].value === catUpper) {
                    selectCat.selectedIndex = i;
                    catFound = true;
                    break;
                }
            }
            if (!catFound) selectCat.value = 'HERO';

            document.getElementById('new-price').value = item.price;
            document.getElementById('new-img').value = item.img;

            const radios = document.getElementsByName('img-source');
            if (radios.length) radios[0].checked = true;
            toggleImageInputMode();

            document.getElementById('new-desc').value = item.desc;

            // Populate New Fields
            const selectLang = document.getElementById('new-lang');
            // Assuming item.lang exists, otherwise default
            selectLang.value = item.lang || 'HTML';

            document.getElementById('new-code').value = item.code || '';

            // Set Edit Mode
            document.getElementById('edit-mode-id').value = id;
            document.getElementById('form-header').textContent = `EDITING ASSET // ${id.substring(0, 8)}...`;
            document.getElementById('form-submit-btn').textContent = "UPDATE ASSET";
        }

        window.handleComponentSubmit = async function () {
            const title = document.getElementById('new-title').value;
            const cat = document.getElementById('new-cat').value;
            const price = document.getElementById('new-price').value;
            const desc = document.getElementById('new-desc').value;
            // Get new fields
            const lang = document.getElementById('new-lang').value;
            const code = document.getElementById('new-code').value;

            const editId = document.getElementById('edit-mode-id').value;
            const btn = document.getElementById('form-submit-btn');

            // Image Processing
            let finalImg = "https://images.unsplash.com/photo-1550745165-9bc0b252726f?auto=format&fit=crop&w=600&q=80"; // Default

            const mode = document.querySelector('input[name="img-source"]:checked').value;

            if (mode === 'url') {
                const val = document.getElementById('new-img').value;
                if (val) finalImg = val;
            } else {
                // File Upload Handling (Cloudinary)
                const fileInput = document.getElementById('new-img-file');
                if (fileInput.files && fileInput.files[0]) {
                    // UI Feedback
                    const originalBtnText = btn.textContent;
                    btn.textContent = "UPLOADING IMAGE...";
                    btn.style.opacity = "0.7";
                    btn.style.cursor = "wait";

                    try {
                        const file = fileInput.files[0];
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('upload_preset', 'ml_default'); // Cloudinary Upload Preset

                        // Cloudinary API Call
                        const response = await fetch('https://api.cloudinary.com/v1_1/dhpcescz8/image/upload', {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) throw new Error('Cloudinary upload failed');

                        const data = await response.json();
                        finalImg = data.secure_url; // Use the URL from Cloudinary

                    } catch (err) {
                        console.error(err);
                        alert("IMAGE UPLOAD FAILED: " + err.message);
                        // Reset button
                        btn.textContent = originalBtnText;
                        btn.style.opacity = "1";
                        btn.style.cursor = "pointer";
                        return; // Stop submission
                    }
                } else if (editId) {
                    const current = window.velocityStore.getComponent(editId);
                    if (current) finalImg = current.img;
                }
            }

            if (!title || !price) {
                alert("MISSING REQUIRED FIELDS");
                // Reset button state if it was changed during upload attempt
                btn.textContent = editId ? "UPDATE ASSET" : "DEPLOY";
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
                return;
            }

            const componentData = {
                title,
                cat,
                price,
                img: finalImg,
                desc,
                lang, // Save Language
                code  // Save Source Code
            };

            if (editId) {
                // UPDATE MODE
                btn.textContent = "UPDATING DATA...";
                await window.velocityStore.updateComponent(editId, componentData);
            } else {
                // CREATE MODE
                btn.textContent = "DEPLOYING...";
                await window.velocityStore.addComponent(componentData);
            }

            toggleAdminForm(false);
            renderAdminDashboard(); // Re-render list
        }

        window.deleteAsset = function (id) {
            if (confirm("CONFIRM DELETION PROTOCOL?")) {
                window.velocityStore.deleteComponent(id);
                renderAdminDashboard();
            }
        }


        // --- 2. GLOBAL STATE ---
        let scene, camera, renderer, controls;
        let sphereObject, keyboardGroup, wheelObject;
        let raycaster, mouse = new THREE.Vector2(), INTERSECTED = null;
        let clock = new THREE.Clock();
        let keysRegistry = {};

        // DOM Elements
        let heroSectionElement, heroTitleElement, heroSpanElement;
        let whySectionElement, whyTitleElement, whySub1Element, whySub2Element;
        let workCtaElement; // Added CTA Element
        let marqueeSectionElement, marqueeTrackElement;
        let navCenter, navRight;
        let dualGridSectionElement, methTitleElement, methDescElement, methKeywordsContainer, methKw1, methKw2, methKw3;
        let philTitleElement, philDescElement, philQuoteContainer, philQuote;
        let marketplaceWrapper, marketplaceOpen = false, cardsContainer;
        let isPageOpen = false;
        let searchInput, filterPillsContainer;

        let scrollAmount = 0;
        let smoothedScrollAmount = 0;
        let currentScroll = 0;
        let lastTransitionTime = 0;

        let currentTab = 'trending';
        let currentCategoryFilter = 'All';
        let searchQuery = '';

        const categories = ['All', 'Hero', 'Section', 'Button', 'Card', 'Background', 'Header', 'Logo', 'Feature', 'Pricing', 'Testimonial', 'Footer', 'Form', 'Heading'];

        // --- SCROLL SNAPPING VARIABLES ---
        let isUserScrolling = false;
        let snapTimeout;
        let targetSnap = null;
        // Points (0.0 to 1.0) where the scroll should settle for best readability
        const SNAP_POINTS = [
            0.0,   // Hero Section
            0.67,  // Why Section (Centered text)
            0.93   // Dual Grid Section (Adjusted to 0.93 for new range)
        ];

        // --- 3. UTILITY FUNCTIONS ---
        function lerp(start, end, t) { return start * (1 - t) + end * t; }
        function mapRange(value, inMin, inMax, outMin, outMax) {
            const clampedValue = THREE.MathUtils.clamp(value, inMin, inMax);
            return outMin + (outMax - outMin) * (clampedValue - inMin) / (inMax - inMin);
        }
        function easeOutCubic(x) { return 1 - Math.pow(1 - x, 3); }
        function interpolateColorStyles(startRGB, endRGB, factor) {
            const r = Math.round(lerp(startRGB[0], endRGB[0], factor));
            const g = Math.round(lerp(startRGB[1], endRGB[1], factor));
            const b = Math.round(lerp(startRGB[2], endRGB[2], factor));
            return `rgb(${r}, ${g}, ${b})`;
        }

        // Global Number Formatter
        const kFormatter = (num) => Math.abs(num) > 999 ? Math.sign(num) * ((Math.abs(num) / 1000).toFixed(1)) + 'k' : Math.sign(num) * Math.abs(num);

        // --- AUTH SYSTEM (Secure Handler) ---
        window.velocityAuth = {
            isAdmin: false,
            authenticate: async (email, password, mode, racerId) => {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        if (mode === 'signup') {
                            reject(new Error("REGISTRATION CLOSED. INVITE ONLY."));
                        } else if (mode === 'login') {
                            // Check Racer ID instead of Email since Email is hidden in login mode
                            if (racerId.toLowerCase() === 'admin' && password === 'velocity') {
                                window.velocityAuth.isAdmin = true;
                                updateUIForAdmin();
                                closePage();
                                // Redirect to Dashboard immediately
                                setTimeout(() => openPage('configure'), 500);
                                resolve();
                            } else {
                                reject(new Error("INVALID CREDENTIALS."));
                            }
                        } else {
                            reject(new Error("INVALID MODE"));
                        }
                    }, 1500); // Simulated delay
                });
            }
        };

        function updateUIForAdmin() {
            const navRight = document.getElementById('nav-right');
            const navCenter = document.getElementById('nav-center'); // Target center nav
            const loginLink = navRight.querySelector('a'); // The existing LOGIN link

            // Reveal Configure Buttons
            const configBtn = document.getElementById('nav-configure-btn');
            const mobileConfigBtn = document.getElementById('mobile-nav-configure-btn');
            if (configBtn) configBtn.classList.remove('hidden');
            if (mobileConfigBtn) mobileConfigBtn.classList.remove('hidden');

            // 2. Transform Login Link to Logout
            if (loginLink) {
                loginLink.textContent = "LOGOUT";
                loginLink.classList.remove('text-white');
                loginLink.classList.add('text-red-500'); // Make logout red

                // Override click handler for logout
                loginLink.onclick = () => {
                    window.velocityAuth.isAdmin = false;

                    // Hide Configure Buttons Again
                    if (configBtn) configBtn.classList.add('hidden');
                    if (mobileConfigBtn) mobileConfigBtn.classList.add('hidden');

                    // Reset Login Link
                    loginLink.textContent = "LOGIN";
                    loginLink.classList.remove('text-red-500');
                    loginLink.classList.add('text-white');
                    loginLink.onclick = () => openPage('login');

                    // Close restricted pages if open
                    const conceptFrame = document.getElementById('concept-frame-container');
                    const currentLoaded = conceptFrame.getAttribute('data-loaded');
                    if (conceptFrame.style.display === 'block' && currentLoaded === 'configure') {
                        closePage();
                    }

                    // Also close overlay if text content (e.g. configure text) is shown
                    if (document.getElementById('page-overlay').classList.contains('active')) {
                        const titleText = document.getElementById('page-overlay-title').innerText;
                        if (titleText.includes("CONFIG")) closePage();
                    }

                    alert("SESSION TERMINATED.");
                };
            }

            // Show Success Notification
            const toast = document.createElement('div');
            toast.className = "fixed top-24 right-8 bg-red-600/90 text-white px-6 py-3 rounded border border-white/20 shadow-2xl z-[200] font-['Michroma'] text-xs tracking-widest backdrop-blur-md animate-bounce";
            toast.innerHTML = "WELCOME BACK, COMMANDER.";
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // --- PAGE OVERLAY FUNCTIONS ---
        window.openPage = function (pageId) {
            const overlay = document.getElementById('page-overlay');
            const titleEl = document.getElementById('page-overlay-title');
            const bodyEl = document.getElementById('page-overlay-body');
            const contentEl = document.getElementById('page-content');
            const conceptFrame = document.getElementById('concept-frame-container');

            if (!overlay) return;

            // Check Access for Configure
            if (pageId === 'configure' && !window.velocityAuth.isAdmin) {
                alert("ACCESS DENIED: AUTHORIZATION REQUIRED.");
                return;
            }

            overlay.classList.add('active');
            isPageOpen = true;

            if (pageId === 'concept') {
                contentEl.style.display = 'none';
                conceptFrame.style.display = 'block';
                // Reset data-loaded attribute if switching context
                if (conceptFrame.getAttribute('data-loaded') !== 'concept') {
                    conceptFrame.innerHTML = `<iframe srcdoc='${CONCEPT_HTML.replace(/'/g, "&apos;")}' style="width:100%; height:100%; border:none;"></iframe>`;
                    conceptFrame.setAttribute('data-loaded', 'concept');
                }
            } else if (pageId === 'engineering') {
                // ENGINEERING MODE (New)
                contentEl.style.display = 'none';
                conceptFrame.style.display = 'block';
                if (conceptFrame.getAttribute('data-loaded') !== 'engineering') {
                    conceptFrame.innerHTML = `<iframe srcdoc='${ENGINEERING_HTML.replace(/'/g, "&apos;")}' style="width:100%; height:100%; border:none;"></iframe>`;
                    conceptFrame.setAttribute('data-loaded', 'engineering');
                }
            } else if (pageId === 'login') {
                contentEl.style.display = 'none';
                conceptFrame.style.display = 'block';
                // Inject the new LOGIN_HTML into the iframe
                if (conceptFrame.getAttribute('data-loaded') !== 'login') {
                    conceptFrame.innerHTML = `<iframe srcdoc='${LOGIN_HTML.replace(/'/g, "&apos;")}' style="width:100%; height:100%; border:none;"></iframe>`;
                    conceptFrame.setAttribute('data-loaded', 'login');
                }
            } else if (pageId === 'configure') {
                // ADMIN DASHBOARD MODE
                conceptFrame.style.display = 'none';
                contentEl.style.display = 'flex';

                titleEl.innerText = pagesContent.configure.title;
                // Render the dynamic dashboard instead of static content
                renderAdminDashboard();

                setTimeout(() => {
                    contentEl.style.opacity = '1';
                    contentEl.style.transform = 'translateY(0)';
                }, 300);

            } else {
                const data = pagesContent[pageId];
                if (!data) return;
                conceptFrame.style.display = 'none';
                contentEl.style.display = 'flex';
                titleEl.innerText = data.title;
                bodyEl.innerHTML = data.content;
                setTimeout(() => {
                    contentEl.style.opacity = '1';
                    contentEl.style.transform = 'translateY(0)';
                }, 300);
            }
        };

        window.closePage = function () {
            const overlay = document.getElementById('page-overlay');
            const contentEl = document.getElementById('page-content');
            const conceptFrame = document.getElementById('concept-frame-container');

            contentEl.style.opacity = '0';
            contentEl.style.transform = 'translateY(20px)';

            // We delay hiding the frame slightly or hide immediately
            conceptFrame.style.display = 'none';
            contentEl.style.display = 'flex';

            overlay.classList.remove('active');
            isPageOpen = false;
        };

        window.toggleMobileMenu = function () {
            const menu = document.getElementById('mobile-menu');
            const isOpen = !menu.classList.contains('translate-x-full');
            if (isOpen) {
                menu.classList.add('translate-x-full');
            } else {
                menu.classList.remove('translate-x-full');
            }
        }

        // --- 4. RENDER FUNCTIONS ---
        function renderPills() {
            if (!filterPillsContainer) return;
            filterPillsContainer.innerHTML = '';

            categories.forEach(cat => {
                const btn = document.createElement('button');
                // Uses tailwind classes for styling the pill
                const isActive = currentCategoryFilter === cat;
                btn.className = `filter-pill ${isActive ? 'active' : ''}`;
                btn.onclick = () => filterByCategory(cat);
                btn.innerHTML = `${cat}`;
                filterPillsContainer.appendChild(btn);
            });
        }

        function renderCards() {
            if (!cardsContainer) return;
            cardsContainer.innerHTML = '';
            
            // Use velocityStore.products if initialized, else fallback (though init does it)
            const source = window.velocityStore ? window.velocityStore.products : products;
            let data = [];

            // LOGIC UPDATE: Dynamic Trending Filtering
            if (currentTab === 'trending') {
                 const allComponents = window.velocityStore ? window.velocityStore.getAllComponents() : [];
                 data = allComponents.sort((a, b) => {
                    const scoreA = (a.views || 0) + ((a.downloads || 0) * 4);
                    const scoreB = (b.views || 0) + ((b.downloads || 0) * 4);
                    return scoreB - scoreA;
                });
            } else {
                data = source[currentTab] || [];
            }
            
            if (currentCategoryFilter !== 'All') {
                data = data.filter(item => item.cat === currentCategoryFilter.toUpperCase());
            }
            
            if (searchQuery) {
                const q = searchQuery.toLowerCase();
                data = data.filter(item => 
                    item.title.toLowerCase().includes(q) || 
                    item.desc.toLowerCase().includes(q)
                );
            }

            if (data.length === 0) {
                cardsContainer.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-500">
                        <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <p class="font-['Michroma'] text-sm">NO COMPONENTS FOUND</p>
                        <p class="text-xs mt-2 font-['Inter']">Try adjusting your filters or search query.</p>
                    </div>
                `;
                return;
            }

            data.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = `fuel-cell-card group opacity-0`;
                card.style.transition = `opacity 0.6s ease ${index * 0.05}s, transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) ${index * 0.05}s, border-color 0.3s ease, background 0.3s ease`;
                
                // Click handler
                card.onclick = () => openModalWithItem(item); 

                card.innerHTML = `
                    <div class="card-visual">
                        <div class="card-visual-overlay"></div>
                        <img src="${item.img}" alt="${item.title}">
                        <div class="price-stamp">${item.price}</div>
                    </div>
                    <!-- FLEX-GROW content, removed fixed height -->
                    <!-- Updated Padding for Mobile (p-3) vs Desktop (p-6) -->
                    <div class="p-3 md:p-6 flex flex-col flex-grow bg-gradient-to-b from-transparent to-black/80 relative">
                        <div class="flex-grow">
                            <div class="flex justify-between items-start mb-1">
                                <div class="text-[8px] md:text-[10px] font-['Michroma'] text-red-500 tracking-widest opacity-80">${item.cat}</div>
                                <!-- Live Analytics Display -->
                                <div class="flex items-center gap-2 text-[8px] md:text-[9px] font-mono text-gray-500">
                                    <span class="flex items-center gap-0.5" title="Views">
                                        <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                        <span id="stat-views-${item.id}" class="transition-colors duration-300">${kFormatter(item.views || 0)}</span>
                                    </span>
                                    <span class="flex items-center gap-0.5" title="Downloads">
                                        <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                        <span id="stat-downloads-${item.id}" class="transition-colors duration-300">${kFormatter(item.downloads || 0)}</span>
                                    </span>
                                </div>
                            </div>
                            <!-- Updated Text Sizes for Mobile -->
                            <h3 class="font-['Rajdhani'] font-bold text-base md:text-2xl text-white mb-1 md:mb-2 leading-none tracking-wide group-hover:text-red-500 transition-colors truncate">${item.title}</h3>
                            
                            <!-- Clamped Text + Read More -->
                            <div class="relative">
                                <p class="font-['Inter'] text-[10px] md:text-xs text-gray-400 leading-relaxed opacity-80 line-clamp-2 md:line-clamp-3 mb-1">${item.desc}</p>
                                <div class="text-[8px] md:text-[9px] font-['Michroma'] text-red-500 mt-1 md:mt-2 flex items-center gap-1 group-hover:text-white transition-colors">
                                    READ MORE <span class="text-xs">&rsaquo;</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Buttons pinned to bottom, prevented from shrinking -->
                        <div class="flex gap-2 md:gap-3 mt-3 md:mt-4 pt-3 md:pt-4 border-t border-white/5 shrink-0">
                            <button class="w-full flex-1 py-1.5 md:py-2.5 text-[8px] md:text-[10px] font-['Michroma'] border border-white/20 text-white hover:bg-white hover:text-black hover:border-white transition-all duration-300 rounded-sm">PREVIEW</button>
                            <button class="w-full flex-1 py-1.5 md:py-2.5 text-[8px] md:text-[10px] font-['Michroma'] bg-red-600/10 text-red-500 border border-red-600/30 hover:bg-red-600 hover:text-white hover:border-red-600 transition-all duration-300 rounded-sm shadow-[0_0_10px_rgba(220,38,38,0.1)] hover:shadow-[0_0_20px_rgba(220,38,38,0.4)]" onclick="event.stopPropagation()">ACQUIRE</button>
                        </div>
                    </div>
                `;
                cardsContainer.appendChild(card);
            });
            requestAnimationFrame(() => {
                Array.from(cardsContainer.children).forEach(c => { c.style.opacity = '1'; c.style.transform = 'translateY(0)'; });
            });
        }

        // --- REAL-TIME ANALYTICS SIMULATION ---
        function simulateLiveActivity() {
            // Pick a random component to "interact" with
            const allProducts = window.velocityStore.getAllComponents();
            if (allProducts.length === 0) return;

            const randomIdx = Math.floor(Math.random() * allProducts.length);
            const item = allProducts[randomIdx];

            // Randomly increment views (more likely) or downloads (less likely)
            if (Math.random() > 0.8) {
                item.downloads += 1;
                // Update DOM if visible
                const el = document.getElementById(`stat-downloads-${item.id}`);
                if (el) {
                    el.textContent = kFormatter(item.downloads);
                    el.classList.add('text-green-400');
                    setTimeout(() => el.classList.remove('text-green-400'), 1000);
                }
            } else {
                item.views += Math.floor(Math.random() * 5) + 1;
                // Update DOM if visible
                const el = document.getElementById(`stat-views-${item.id}`);
                if (el) {
                    el.textContent = kFormatter(item.views);
                    el.classList.add('text-white'); // Flash white
                    setTimeout(() => el.classList.remove('text-white'), 500);
                }
            }
        }
        // Run simulation loop
        setInterval(simulateLiveActivity, 2000);


        // --- MODAL & PREVIEW FUNCTIONS ---

        // Switch between Preview (Image/Iframe) and Source Code
        window.switchModalView = function (view) {
            const viewPreview = document.getElementById('view-preview');
            const viewCode = document.getElementById('view-code');
            const btnPreview = document.getElementById('btn-view-preview');
            const btnCode = document.getElementById('btn-view-code');
            const btnCopy = document.getElementById('btn-copy-code');

            if (view === 'preview') {
                if (viewPreview) viewPreview.classList.remove('hidden');
                if (viewCode) viewCode.classList.add('hidden');

                if (btnPreview) {
                    btnPreview.classList.remove('text-gray-500', 'hover:text-white', 'hover:bg-white/5');
                    btnPreview.classList.add('text-white', 'bg-white/5');
                }

                if (btnCode) {
                    btnCode.classList.add('text-gray-500', 'hover:text-white', 'hover:bg-white/5');
                    btnCode.classList.remove('text-white', 'bg-white/5');
                }

                if (btnCopy) btnCopy.classList.add('hidden');

            } else {
                if (viewPreview) viewPreview.classList.add('hidden');
                if (viewCode) viewCode.classList.remove('hidden');

                if (btnCode) {
                    btnCode.classList.remove('text-gray-500', 'hover:text-white', 'hover:bg-white/5');
                    btnCode.classList.add('text-white', 'bg-white/5');
                }

                if (btnPreview) {
                    btnPreview.classList.add('text-gray-500', 'hover:text-white', 'hover:bg-white/5');
                    btnPreview.classList.remove('text-white', 'bg-white/5');
                }

                if (btnCopy) btnCopy.classList.remove('hidden');
            }
        }

        window.copyCodeToClipboard = function () {
            const codeText = document.getElementById('modal-code-block').textContent;
            const btn = document.getElementById('btn-copy-code');
            const span = btn.querySelector('span');
            const originalText = "COPY"; // Hardcoded original text

            // Use textarea hack for iframe compatibility
            const textArea = document.createElement("textarea");
            textArea.value = codeText;
            textArea.style.position = "fixed"; // Avoid scrolling to bottom
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.select();

            try {
                document.execCommand('copy');

                // Success State
                span.innerText = "COPIED!";
                btn.classList.remove('text-red-500', 'hover:bg-red-600', 'bg-[#0a0a0a]');
                btn.classList.add('bg-red-600', 'text-white');

                setTimeout(() => {
                    // Reset State
                    span.innerText = originalText;
                    btn.classList.remove('bg-red-600', 'text-white');
                    btn.classList.add('text-red-500', 'hover:bg-red-600', 'bg-[#0a0a0a]');
                }, 2000);
            } catch (err) {
                console.error('Copy failed', err);
                alert("Failed to copy to clipboard");
            }

            document.body.removeChild(textArea);
        }

        // New Modal Function to handle direct item object
        function openModalWithItem(item) {
            // Fix: Changed 'modal-img' to 'modal-image' to match HTML ID
            const imgEl = document.getElementById('modal-image');
            if (imgEl) imgEl.src = item.img;

            // Fix: Corrected IDs to match HTML
            const catEl = document.getElementById('modal-category');
            if (catEl) catEl.innerText = item.cat;

            const titleEl = document.getElementById('modal-title');
            if (titleEl) titleEl.innerText = item.title;

            const descEl = document.getElementById('modal-description');
            if (descEl) descEl.innerText = item.desc;

            const priceEl = document.getElementById('modal-price');
            if (priceEl) priceEl.innerText = item.price;

            // Handle Code / Preview Logic
            const codeBlock = document.getElementById('modal-code-block');
            const iframe = document.getElementById('modal-iframe');

            // Reset View to Preview
            switchModalView('preview');

            // Populate Code Block
            if (codeBlock) {
                if (item.code) {
                    codeBlock.textContent = item.code;
                    if (window.Prism) {
                        codeBlock.className = 'text-xs font-mono text-gray-300 leading-relaxed block p-6';
                        const langClass = item.lang ? 'language-' + item.lang.toLowerCase() : 'language-html';
                        codeBlock.classList.add(langClass);
                        Prism.highlightElement(codeBlock);
                    }
                } else {
                    codeBlock.textContent = "<!-- Source code not available for this component -->";
                }
            }

            // Live Preview Logic for HTML components
            if (iframe) {
                if (item.lang && item.lang.toUpperCase() === 'HTML' && item.code) {
                    iframe.srcdoc = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <script src="https://cdn.tailwindcss.com"><\/script>
                            <style>
                                body { margin: 0; background: #000; color: white; display: flex; align-items: center; justify-content: center; min-height: 100vh; overflow: hidden; }
                            </style>
                        </head>
                        <body>${item.code}</body>
                        </html>
                    `;
                    iframe.classList.remove('hidden');
                    if (imgEl) imgEl.classList.add('hidden');
                } else {
                    // Fallback to Image
                    iframe.classList.add('hidden');
                    iframe.srcdoc = ""; // Clear
                    if (imgEl) imgEl.classList.remove('hidden');
                }
            }

            // Update Spec Sheet
            const specLang = document.getElementById('modal-spec-lang');
            if (specLang) specLang.innerText = item.lang || 'HTML/CSS';

            const modal = document.getElementById('product-modal');
            if (modal) {
                // 1. Unhide from DOM
                modal.classList.remove('hidden');

                // 2. Force reflow to enable transition
                void modal.offsetWidth;

                // 3. Trigger Fade In
                modal.classList.add('active');
            }
        }

        // Legacy wrapper for compatibility if needed elsewhere
        window.openProductModal = function (cat, index) {
            const item = products[cat][index];
            if (item) openModalWithItem(item);
        }

        window.closeProductModal = function () {
            const modal = document.getElementById('product-modal');
            if (!modal) return;

            // 1. Trigger Fade Out
            modal.classList.remove('active');

            // 2. Wait for transition, then Hide from DOM
            setTimeout(() => {
                modal.classList.add('hidden');
                // Reset iframe to stop running code
                const iframe = document.getElementById('modal-iframe');
                if (iframe) iframe.srcdoc = "";
            }, 300);
        }

        window.addEventListener('click', function (e) { if (e.target === document.getElementById('product-modal')) closeProductModal(); });

        window.switchTab = function (cat) {
            currentTab = cat;

            // Update active state of tab buttons
            const btns = document.querySelectorAll('.cmd-tab-btn');
            btns.forEach(b => {
                if (b.innerText.toLowerCase().includes(cat.toLowerCase())) {
                    b.classList.add('active', 'text-white', 'bg-white/10');
                    b.classList.remove('text-gray-400', 'hover:bg-white/5');
                } else {
                    b.classList.remove('active', 'text-white', 'bg-white/10');
                    b.classList.add('text-gray-400', 'hover:bg-white/5');
                }
            });

            // Transition out existing cards
            if (cardsContainer) {
                const cards = Array.from(cardsContainer.children);
                cards.forEach((c) => { c.style.opacity = '0'; c.style.transform = 'translateY(10px)'; });
                setTimeout(() => { renderCards(); }, 200);
            }
        }

        window.filterByCategory = function (cat) {
            currentCategoryFilter = cat;
            renderPills();
            renderCards();
        }

        // --- 5. 3D ASSETS ---
        function createSphere() {
            const sphereGeometry = new THREE.SphereGeometry(1.5, 64, 64);
            const sphereMaterial = new THREE.MeshPhysicalMaterial({ color: SPHERE_COLOR_START, metalness: 0.5, roughness: 0.2, clearcoat: 0.5, clearcoatRoughness: 0.1, transparent: true, opacity: 1.0 });
            return new THREE.Mesh(sphereGeometry, sphereMaterial);
        }

        const textureCache = {};
        function createKeyTexture(label, fontSize = 40) {
            const size = 256; const canvas = document.createElement('canvas'); canvas.width = size; canvas.height = size; const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#050505'; ctx.fillRect(0, 0, size, size);
            if (label) { ctx.fillStyle = '#ffffff'; ctx.font = `bold ${fontSize * 4}px Inter, sans-serif`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.shadowColor = '#ffffff'; ctx.shadowBlur = 10; ctx.fillText(label, size / 2, size / 2); }
            const texture = new THREE.CanvasTexture(canvas); if (renderer) texture.anisotropy = renderer.capabilities.getMaxAnisotropy(); return texture;
        }

        function getKeyMaterial(label, fontSize) {
            const keyId = label + (fontSize || 40);
            if (!textureCache[keyId]) {
                const texture = createKeyTexture(label, fontSize);
                textureCache[keyId] = new THREE.MeshStandardMaterial({ color: 0x000000, map: texture, emissive: 0xffffff, emissiveMap: texture, emissiveIntensity: 1.5, roughness: 0.6, metalness: 0.1, transparent: true, opacity: 1.0 });
            }
            return textureCache[keyId].clone();
        }

        function createIsolatedKeyboard() {
            const group = new THREE.Group(); const u = 0.65; const gap = 0.12;
            function createRow(keysData, zPos) {
                let totalRowWidth = 0; keysData.forEach(k => { totalRowWidth += (k.w * u) + gap; }); totalRowWidth -= gap;
                let currentX = -totalRowWidth / 2 + (keysData[0].w * u) / 2;
                keysData.forEach((key) => {
                    const width = key.w * u;
                    const keyGeo = new THREE.BoxGeometry(width, 0.05, u);
                    let fs = 40; if (key.l.length > 1) fs = 25; const mat = getKeyMaterial(key.l, fs);
                    const mesh = new THREE.Mesh(keyGeo, mat);
                    mesh.castShadow = true;
                    if (key.l.length === 1) keysRegistry[key.l.toUpperCase()] = mesh;
                    mesh.userData.pressOffset = 0; mesh.userData.finalPos = new THREE.Vector3(currentX, 0, zPos);
                    mesh.userData.startPos = new THREE.Vector3((Math.random() - 0.5) * 8, (Math.random() * 3) + 4, (Math.random() - 0.5) * 5);
                    mesh.userData.startRot = new THREE.Euler(Math.random() * Math.PI * 2, Math.random() * Math.PI * 2, Math.random() * Math.PI * 2);
                    mesh.position.copy(mesh.userData.startPos); mesh.rotation.copy(mesh.userData.startRot);
                    group.add(mesh);
                    if (keysData.indexOf(key) < keysData.length - 1) currentX += (key.w * u) / 2 + gap + (keysData[keysData.indexOf(key) + 1].w * u) / 2;
                });
            }
            const keyLayout = [
                [{ l: "esc", w: 1.6 }, { l: "F1", w: 1 }, { l: "F2", w: 1 }, { l: "F3", w: 1 }, { l: "F4", w: 1 }, { l: "F5", w: 1 }, { l: "F6", w: 1 }, { l: "", w: 1.1 }],
                [{ l: "tab", w: 1.6 }, { l: "Q", w: 1 }, { l: "W", w: 1 }, { l: "E", w: 1 }, { l: "R", w: 1 }, { l: "T", w: 1 }, { l: "Y", w: 1 }, { l: "U", w: 1 }],
                [{ l: "shift", w: 2.3 }, { l: "Z", w: 1 }, { l: "X", w: 1 }, { l: "C", w: 1 }, { l: "V", w: 1 }, { l: "B", w: 1 }, { l: "N", w: 1 }, { l: "M", w: 1 }]
            ];
            let z = -2.6;
            keyLayout.forEach(row => { createRow(row, z); z += u + gap; });
            return group;
        }

        function createWheel() {
            // Optimized Textures (Reduced Ops)
            const brakeDiscMap = (function () { const c = document.createElement('canvas'); c.width = 256; c.height = 256; const x = c.getContext('2d'); x.fillStyle = '#FFF'; x.fillRect(0, 0, 256, 256); x.fillStyle = '#000'; for (let r = 50; r < 115; r += 12) { for (let i = 0; i < Math.PI * 2 * r / 10; i++) { const a = i / (Math.PI * 2 * r / 10) * Math.PI * 2; x.beginPath(); x.arc(128 + Math.cos(a) * r, 128 + Math.sin(a) * r, 2, 0, Math.PI * 2); x.fill(); } } return new THREE.CanvasTexture(c); })();
            const tireMap = (function () { const c = document.createElement('canvas'); c.width = 512; c.height = 512; const x = c.getContext('2d'); x.fillStyle = '#111'; x.fillRect(0, 0, 512, 512); for (let i = 0; i < 5000; i++) { x.fillStyle = `rgba(255,255,255,${Math.random() * 0.05})`; x.fillRect(Math.random() * 512, Math.random() * 512, 2, 2); } return new THREE.CanvasTexture(c); })();

            const group = new THREE.Group();
            const rubberMaterial = new THREE.MeshStandardMaterial({ color: 0x1a1a1a, roughness: 0.6, metalness: 0.1, map: tireMap, bumpMap: tireMap, bumpScale: 0.02, transparent: true, opacity: 1.0 });
            const rimMaterial = new THREE.MeshStandardMaterial({ color: 0xaaaaaa, roughness: 0.4, metalness: 0.8, transparent: true, opacity: 1.0 });
            const brakeDiscMaterial = new THREE.MeshStandardMaterial({ color: 0xaaaaaa, map: brakeDiscMap, alphaMap: brakeDiscMap, transparent: true, side: THREE.DoubleSide, roughness: 0.3, metalness: 0.9, opacity: 1.0 });
            const hubMaterial = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.5, metalness: 0.7, transparent: true, opacity: 1.0 });

            // Main Meshes
            const tire = new THREE.Mesh(new THREE.TorusGeometry(WHEEL_CONFIG.tireRadius, WHEEL_CONFIG.tireTube / 1.8, 32, 48), rubberMaterial); tire.scale.set(1, 1, 1.8); group.add(tire);
            const sl = new THREE.Mesh(new THREE.RingGeometry(WHEEL_CONFIG.rimRadius, WHEEL_CONFIG.tireRadius + WHEEL_CONFIG.tireTube / 3.6, 48), rubberMaterial); sl.position.z = WHEEL_CONFIG.rimWidth / 2; sl.rotation.y = Math.PI; group.add(sl);
            const sr = new THREE.Mesh(new THREE.RingGeometry(WHEEL_CONFIG.rimRadius, WHEEL_CONFIG.tireRadius + WHEEL_CONFIG.tireTube / 3.6, 48), rubberMaterial); sr.position.z = -WHEEL_CONFIG.rimWidth / 2; group.add(sr);
            const rim = new THREE.Mesh(new THREE.CylinderGeometry(WHEEL_CONFIG.rimRadius, WHEEL_CONFIG.rimRadius, WHEEL_CONFIG.rimWidth, 48, 1, true).rotateX(Math.PI / 2), rimMaterial); group.add(rim);

            // Instanced Spokes
            const spokeGeo = new THREE.CylinderGeometry(0.4, 0.2, WHEEL_CONFIG.rimRadius - 1, 8);
            spokeGeo.rotateX(Math.PI / 2); // Align for rotation
            const spokeMesh = new THREE.InstancedMesh(spokeGeo, rimMaterial, WHEEL_CONFIG.spokeCount);
            const dummy = new THREE.Object3D();
            for (let i = 0; i < WHEEL_CONFIG.spokeCount; i++) {
                const angle = (i / WHEEL_CONFIG.spokeCount) * Math.PI * 2;
                dummy.position.set(Math.cos(angle) * (WHEEL_CONFIG.rimRadius / 2), Math.sin(angle) * (WHEEL_CONFIG.rimRadius / 2), 0);
                dummy.rotation.set(0, 0, angle - Math.PI / 2);
                dummy.updateMatrix();
                spokeMesh.setMatrixAt(i, dummy.matrix);
            }
            group.add(spokeMesh);

            group.add(new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.5, 6, 24).rotateX(Math.PI / 2), hubMaterial));
            const disc = new THREE.Mesh(new THREE.RingGeometry(0.8, WHEEL_CONFIG.brakeDiscRadius, 48), brakeDiscMaterial); disc.position.z = 1.8; group.add(disc);
            const discBack = disc.clone(); discBack.rotation.y = Math.PI; discBack.position.z = 1.9; group.add(discBack);
            group.scale.set(WHEEL_CONFIG.scaleFactor, WHEEL_CONFIG.scaleFactor, WHEEL_CONFIG.scaleFactor);
            return group;
        }

        // --- 6. INIT & LOOP ---
        function onMouseMove(event) { mouse.x = (event.clientX / window.innerWidth) * 2 - 1; mouse.y = - (event.clientY / window.innerHeight) * 2 + 1; }

        function onScroll(event) {
            if (isPageOpen) return;

            // Check if we are in the Marketplace view
            if (marketplaceOpen) {
                const isAtTop = marketplaceWrapper.scrollTop <= 0;
                const isScrollingUp = event.deltaY < 0;

                if (isAtTop && isScrollingUp) {
                    event.preventDefault();
                    const now = Date.now();
                    if (now - lastTransitionTime > 1000) {
                        marketplaceOpen = false;
                        lastTransitionTime = now;
                        currentScroll = MAX_SCROLL_AMOUNT - 500;
                        scrollAmount = currentScroll / MAX_SCROLL_AMOUNT;
                    }
                }
            } else {
                // 3D Timeline Mode - Hijack logic
                event.preventDefault();

                // Flag scrolling active
                isUserScrolling = true;
                targetSnap = null; // Cancel any active auto-snap
                clearTimeout(snapTimeout);

                currentScroll = Math.max(0, Math.min(MAX_SCROLL_AMOUNT, currentScroll + event.deltaY));
                scrollAmount = currentScroll / MAX_SCROLL_AMOUNT;

                if (sphereObject) sphereObject.rotation.y += event.deltaY * scrollRotationSpeed;
                if (wheelObject && wheelObject.visible) wheelObject.rotation.z -= (event.deltaY * 0.002);

                const now = Date.now();
                if (scrollAmount >= 0.995) {
                    if (now - lastTransitionTime > 1000) {
                        marketplaceOpen = true;
                        lastTransitionTime = now;
                    }
                }

                // Set timeout to detect scroll stop
                snapTimeout = setTimeout(() => {
                    initiateSnap();
                }, 150); // 150ms of no input = stop
            }
        }

        function initiateSnap() {
            isUserScrolling = false;
            // Find nearest snap point
            const currentRatio = currentScroll / MAX_SCROLL_AMOUNT;
            let closest = SNAP_POINTS[0];
            let minDiff = 100; // Large initial value

            SNAP_POINTS.forEach(p => {
                const diff = Math.abs(p - currentRatio);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = p;
                }
            });

            // Only snap if we are within a reasonable "magnetic" range (e.g., 10%)
            // This prevents snapping across huge distances if the user intentionally stops in transition
            if (minDiff < 0.12) {
                targetSnap = closest * MAX_SCROLL_AMOUNT;
            }
        }

        let touchStartY = 0;
        document.addEventListener('touchstart', e => {
            touchStartY = e.touches[0].clientY;
            isUserScrolling = true; // User is touching
            targetSnap = null;      // Stop auto movement
            clearTimeout(snapTimeout);
        }, { passive: false });

        document.addEventListener('touchmove', e => {
            if (isPageOpen) return;
            if (marketplaceOpen) {
                const touchY = e.touches[0].clientY;
                const deltaY = (touchStartY - touchY) * 2;
                const isAtTop = marketplaceWrapper.scrollTop <= 0;
                const isScrollingUp = deltaY < 0;

                if (isAtTop && isScrollingUp) {
                    e.preventDefault();
                    onScroll({ preventDefault: () => { }, deltaY: deltaY });
                    touchStartY = touchY;
                } else {
                    touchStartY = touchY; // Allow native
                }
            } else {
                e.preventDefault();
                const touchY = e.touches[0].clientY;
                const deltaY = (touchStartY - touchY) * 2;
                touchStartY = touchY;
                onScroll({ preventDefault: () => { }, deltaY: deltaY });
            }
        }, { passive: false });

        // Add touchend to trigger snap on mobile
        document.addEventListener('touchend', () => {
            // Delay slightly to let any momentum settle if we were implementing momentum, 
            // but since we are hijacking, we snap immediately on release.
            initiateSnap();
        }, { passive: false });


        function onWindowResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }

        function init() {
            const container = document.getElementById('webgl-container');
            heroSectionElement = document.getElementById('hero-section');
            heroTitleElement = document.getElementById('hero-title');
            heroSpanElement = document.getElementById('hero-span');
            whySectionElement = document.getElementById('why-section');
            whyTitleElement = document.getElementById('why-title');
            whySub1Element = document.getElementById('why-sub1');
            whySub2Element = document.getElementById('why-sub2');
            workCtaElement = document.getElementById('work-cta');
            marqueeSectionElement = document.getElementById('marquee-section');
            marqueeTrackElement = document.getElementById('marquee-track');
            navCenter = document.getElementById('nav-center');
            navRight = document.getElementById('nav-right');
            dualGridSectionElement = document.getElementById('dual-grid-section');
            methTitleElement = document.getElementById('meth-title');
            methDescElement = document.getElementById('meth-desc');
            methKeywordsContainer = document.getElementById('meth-keywords');
            methKw1 = document.getElementById('kw-1');
            methKw2 = document.getElementById('kw-2');
            methKw3 = document.getElementById('kw-3');
            philTitleElement = document.getElementById('phil-title');
            philDescElement = document.getElementById('phil-desc');
            philQuoteContainer = document.getElementById('phil-quote-container');
            philQuote = document.getElementById('phil-quote');
            marketplaceWrapper = document.getElementById('marketplace-wrapper');
            cardsContainer = document.getElementById('cards-container');

            // New Elements
            searchInput = document.getElementById('search-input');
            filterPillsContainer = document.getElementById('filter-pills-container');

            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    searchQuery = e.target.value.trim();
                    renderCards();
                });
            }

            renderPills();
            renderCards(); // Initial render

            scene = new THREE.Scene(); scene.background = new THREE.Color(0x000000);
            const isMobile = window.innerWidth < 768;
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, TOP_SPHERE_Y + 3.5, isMobile ? CAMERA_Z_START + 2 : CAMERA_Z_START);

            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true; renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);
            raycaster = new THREE.Raycaster(); mouse = new THREE.Vector2();

            const ambientLight = new THREE.AmbientLight(AMBIENT_COLOR); scene.add(ambientLight);
            const spotLight = new THREE.SpotLight(SPOTLIGHT_COLOR, 30); spotLight.position.set(0, 10, 0);
            spotLight.angle = Math.PI / 8; spotLight.penumbra = 0.5; spotLight.decay = 2; spotLight.distance = 50; spotLight.castShadow = true;
            spotLight.shadow.mapSize.width = 1024; spotLight.shadow.mapSize.height = 1024;
            scene.add(spotLight); scene.add(spotLight.target);

            sphereObject = new THREE.Group(); sphereObject.add(createSphere()); sphereObject.position.y = TOP_SPHERE_Y; scene.add(sphereObject);
            keyboardGroup = createIsolatedKeyboard(); keyboardGroup.position.set(KEYBOARD_X_POSITION, KEYBOARD_Y, 0); keyboardGroup.rotation.x = -Math.PI / 4; keyboardGroup.scale.set(0.6, 0.6, 0.6); scene.add(keyboardGroup);
            wheelObject = createWheel(); wheelObject.position.set(-KEYBOARD_X_POSITION, LOWEST_TARGET_Y, 0); wheelObject.rotation.x = Math.PI / 2; wheelObject.rotation.y = Math.PI / 4; scene.add(wheelObject);
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(20, 20), new THREE.MeshPhongMaterial({ color: GROUND_COLOR })); ground.rotation.x = -Math.PI / 2; ground.position.y = 0; ground.receiveShadow = true; scene.add(ground);

            controls = new THREE.OrbitControls(camera, renderer.domElement); controls.enableDamping = true; controls.dampingFactor = 0.08; controls.screenSpacePanning = true; controls.minDistance = 3; controls.maxDistance = 15; controls.target.set(0, TOP_SPHERE_Y, 0); controls.enableZoom = false;

            window.addEventListener('resize', onWindowResize, false); window.addEventListener('mousemove', onMouseMove, false); window.addEventListener('wheel', onScroll, { passive: false });
            animate();
        }

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);
            const elapsedTime = clock.getElapsedTime();

            // Magnetic Snap Logic
            if (!isUserScrolling && targetSnap !== null && !marketplaceOpen) {
                // Smoothly interpolate currentScroll towards targetSnap
                // 0.05 is the speed of the "magnet" (lower = slower/smoother)
                currentScroll = lerp(currentScroll, targetSnap, 0.05);
                scrollAmount = currentScroll / MAX_SCROLL_AMOUNT;

                // If extremely close, lock it to save calc
                if (Math.abs(currentScroll - targetSnap) < 1) {
                    currentScroll = targetSnap;
                    scrollAmount = currentScroll / MAX_SCROLL_AMOUNT;
                    targetSnap = null; // Snap complete
                }
            }

            smoothedScrollAmount = lerp(smoothedScrollAmount, scrollAmount, SMOOTHING_FACTOR);
            const s = smoothedScrollAmount;

            if (marketplaceWrapper) {
                if (marketplaceOpen) {
                    marketplaceWrapper.style.transform = 'translateY(0%)';
                    marketplaceWrapper.classList.add('marketplace-active');
                } else {
                    marketplaceWrapper.style.transform = 'translateY(100%)';
                    marketplaceWrapper.classList.remove('marketplace-active');
                }
            }

            const colorProgress = mapRange(s, 0.0, 0.3, 0.0, 1.0);
            if (sphereObject && sphereObject.children[0].material) { sphereObject.children[0].material.color.lerpColors(SPHERE_COLOR_START, SPHERE_COLOR_END, colorProgress); }
            if (heroTitleElement && heroSpanElement) {
                const textStart = [220, 220, 220]; const textEnd = [255, 255, 255];
                const currentColor = interpolateColorStyles(textStart, textEnd, colorProgress);
                heroTitleElement.style.color = currentColor; heroSpanElement.style.color = currentColor;
            }
            if (heroSectionElement) {
                const heroOpacity = mapRange(s, 0.0, 0.5, 1.0, 0.0);
                heroSectionElement.style.opacity = heroOpacity;
                if (heroOpacity > 0.01) {
                    const scale = 1 + (s * 0.3);
                    heroSectionElement.style.transform = `translate(-50%, -50%) scale(${scale})`;
                    heroSectionElement.style.display = 'block';
                } else { heroSectionElement.style.display = 'none'; }
            }

            if (navCenter && navRight) {
                let navAlpha = 1;
                if (s > 0.05) { navAlpha = mapRange(s, 0.05, 0.15, 1, 0); }
                navCenter.style.opacity = navAlpha; navRight.style.opacity = navAlpha;
                const ptr = navAlpha < 0.1 ? 'none' : 'auto';
                navCenter.style.pointerEvents = ptr; navRight.style.pointerEvents = ptr;
            }

            const transitionPoint1 = 0.5; const transitionPoint2 = 0.8;
            let targetY, targetX;
            if (s <= transitionPoint1) {
                const t = mapRange(s, 0.0, transitionPoint1, 0.0, 1.0);
                targetY = lerp(TOP_SPHERE_Y, KEYBOARD_Y, t);
                targetX = lerp(0.0, KEYBOARD_X_POSITION, t);
            } else if (s <= transitionPoint2) {
                targetY = KEYBOARD_Y; targetX = KEYBOARD_X_POSITION;
            } else {
                const t = mapRange(s, transitionPoint2, 0.98, 0.0, 1.0);
                targetY = lerp(KEYBOARD_Y, LOWEST_TARGET_Y, t);
                targetX = lerp(KEYBOARD_X_POSITION, -KEYBOARD_X_POSITION, t);
            }
            controls.target.y = targetY; controls.target.x = targetX;
            camera.position.z = lerp(CAMERA_Z_START, CAMERA_Z_END, s);
            camera.position.x = targetX;
            camera.position.y = lerp(TOP_SPHERE_Y + 3.5, LOWEST_TARGET_Y + 0.5, s);
            controls.enableZoom = (s >= 0.99);

            const opacitySphere = mapRange(s, 0.0, 0.4, 1.0, 0.0);
            if (sphereObject && sphereObject.children[0].material) {
                sphereObject.children[0].material.opacity = opacitySphere;
                sphereObject.visible = opacitySphere > 0.01;
                if (sphereObject.visible) sphereObject.rotation.y += IDLE_ROTATION_SPEED;
            }

            if (keyboardGroup) {
                let currentKeyboardOpacity = 1.0;
                const formOpacity = mapRange(s, 0.1, 0.5, 0.0, 1.0);
                const bgPhaseOpacity = mapRange(s, 0.45, 0.55, 1.0, 0.3);
                const exitOpacity = mapRange(s, 0.80, 0.88, 0.3, 0.0);
                if (s < 0.45) currentKeyboardOpacity = formOpacity;
                else if (s < 0.80) currentKeyboardOpacity = bgPhaseOpacity;
                else currentKeyboardOpacity = exitOpacity;
                keyboardGroup.visible = currentKeyboardOpacity > 0.01;
                if (keyboardGroup.visible) {
                    const formationRaw = mapRange(s, 0.1, 0.5, 0, 1);
                    const easedProgress = easeOutCubic(formationRaw);
                    const slantProgress = mapRange(s, 0.5, 0.65, 0.0, 1.0);
                    const easedSlant = easeOutCubic(slantProgress);
                    const baseRotX = lerp(-Math.PI / 2, -Math.PI / 4, easedProgress);
                    const slantZ = lerp(0, Math.PI / 8, easedSlant);
                    const moveX = lerp(0, 1.5, easedSlant);
                    let exitRotX = 0, exitRotZ = 0;
                    if (s > 0.80) {
                        const exitProg = mapRange(s, 0.80, 0.88, 0, 1);
                        exitRotX = lerp(0, -Math.PI / 4, exitProg);
                        exitRotZ = lerp(0, -Math.PI / 4, exitProg);
                    }
                    keyboardGroup.rotation.x = baseRotX + exitRotX;
                    keyboardGroup.rotation.z = slantZ + exitRotZ;
                    keyboardGroup.position.x = KEYBOARD_X_POSITION + moveX;
                    keyboardGroup.children.forEach(mesh => {
                        mesh.userData.pressOffset = lerp(mesh.userData.pressOffset, 0, 0.1);
                        if (mesh.material) {
                            const targetEmissive = 1.5;
                            mesh.material.emissiveIntensity = lerp(mesh.material.emissiveIntensity, targetEmissive, 0.1);
                            const curR = mesh.material.emissive.r;
                            const curG = mesh.material.emissive.g;
                            const curB = mesh.material.emissive.b;
                            mesh.material.emissive.setRGB(lerp(curR, 1, 0.1), lerp(curG, 1, 0.1), lerp(curB, 1, 0.1));
                        }
                        if (mesh.userData.finalPos && mesh.userData.startPos) {
                            mesh.position.lerpVectors(mesh.userData.startPos, mesh.userData.finalPos, easedProgress);
                            mesh.position.y += mesh.userData.pressOffset;
                            mesh.rotation.x = lerp(mesh.userData.startRot.x, 0, easedProgress);
                            mesh.rotation.y = lerp(mesh.userData.startRot.y, 0, easedProgress);
                            mesh.rotation.z = lerp(mesh.userData.startRot.z, 0, easedProgress);
                            if (mesh.material) mesh.material.opacity = currentKeyboardOpacity;
                        }
                    });
                    keyboardGroup.rotation.y += IDLE_ROTATION_SPEED;
                }

                // PHASE 2 & CTA LOGIC
                if (whySectionElement) {
                    const inWhyPhase = s > 0.45 && s < 0.88;

                    if (inWhyPhase) {
                        whySectionElement.style.display = 'block';
                        let whyOpacity = 1;
                        if (s < 0.5) whyOpacity = mapRange(s, 0.45, 0.5, 0, 1);
                        else if (s > 0.80) {
                            const exitProgress = mapRange(s, 0.80, 0.88, 0, 1);
                            whySectionElement.style.transform = `translate(${lerp(0, 40, exitProgress)}vw, -50%) scale(${lerp(1, 0.05, exitProgress)})`;
                            whySectionElement.style.opacity = lerp(1, 0, exitProgress);
                        } else {
                            whySectionElement.style.transform = 'translate(0, -50%) scale(1)';
                            whySectionElement.style.opacity = 1;
                        }
                        const titleProgress = mapRange(s, 0.5, 0.60, 0, 1);
                        whyTitleElement.textContent = TXT_TITLE.substring(0, Math.floor(titleProgress * TXT_TITLE.length));
                        const sub1Progress = mapRange(s, 0.60, 0.70, 0, 1);
                        whySub1Element.textContent = TXT_SUB1.substring(0, Math.floor(sub1Progress * TXT_SUB1.length));
                        const sub2Progress = mapRange(s, 0.70, 0.80, 0, 1);
                        whySub2Element.textContent = TXT_SUB2.substring(0, Math.floor(sub2Progress * TXT_SUB2.length));
                    } else { whySectionElement.style.display = 'none'; }

                    // CTA Animation (Sync with text stability)
                    if (workCtaElement) {
                        if (s > 0.55 && s < 0.80) {
                            workCtaElement.style.opacity = '1';
                            workCtaElement.style.transform = 'translateY(0)';
                            workCtaElement.style.pointerEvents = 'auto';
                        } else {
                            workCtaElement.style.opacity = '0';
                            workCtaElement.style.transform = 'translateY(10px)';
                            workCtaElement.style.pointerEvents = 'none';
                        }
                    }
                }
            }

            if (marqueeSectionElement) {
                if (s > 0.75 && s < 0.88) {
                    marqueeSectionElement.style.display = 'block';
                    let mOpacity = 1;
                    if (s < 0.78) mOpacity = mapRange(s, 0.75, 0.78, 0, 1);
                    else if (s > 0.85) mOpacity = mapRange(s, 0.85, 0.88, 1, 0);
                    marqueeSectionElement.style.opacity = mOpacity;
                    marqueeTrackElement.style.transform = `translateX(${mapRange(s, 0.75, 0.88, 100, -100)}%)`;
                } else { marqueeSectionElement.style.display = 'none'; }
            }

            const wheelEntryProgress = mapRange(s, 0.80, 0.88, 0.0, 1.0); // Earlier entry
            let wheelYPos = LOWEST_TARGET_Y;
            if (s > 0.86) { // Earlier lift
                const fixedProgress = mapRange(s, 0.86, 0.90, 0, 1);
                wheelYPos = lerp(LOWEST_TARGET_Y, controls.target.y, easeOutCubic(fixedProgress));
            }
            let wheelOpacityMultiplier = 1;
            // Delayed wheel fade to match extended grid visibility (0.985 - 0.998)
            if (s > 0.985) {
                const fadeProg = mapRange(s, 0.985, 0.998, 0, 1);
                wheelOpacityMultiplier = lerp(1, 0.15, fadeProg);
            }
            if (wheelObject) {
                wheelObject.position.y = wheelYPos;
                wheelObject.children.forEach(mesh => {
                    if (mesh.material) {
                        if (Array.isArray(mesh.material)) {
                            mesh.material.forEach(mat => { if (mat.transparent) mat.opacity = wheelEntryProgress * wheelOpacityMultiplier; });
                        } else if (mesh.material.transparent) {
                            mesh.material.opacity = wheelEntryProgress * wheelOpacityMultiplier;
                        }
                    } else if (mesh.isInstancedMesh && mesh.material.transparent) {
                        mesh.material.opacity = wheelEntryProgress * wheelOpacityMultiplier;
                    }
                });
                wheelObject.visible = (wheelEntryProgress > 0.01);
                if (wheelObject.visible) {
                    wheelObject.rotation.z -= 0.025;
                    const targetScale = WHEEL_CONFIG.scaleFactor;
                    const currentScale = lerp(0.1, targetScale, easeOutCubic(wheelEntryProgress));
                    wheelObject.scale.set(currentScale, currentScale, currentScale);
                }
            }

            // DUAL GRID - Extended Range (0.88 - 0.998)
            if (dualGridSectionElement) {
                if (s > 0.88 && s < 0.998) {
                    dualGridSectionElement.style.display = 'flex';
                    let gridOpacity = 1;

                    // Fade in earlier (0.88 - 0.91)
                    if (s < 0.91) { gridOpacity = mapRange(s, 0.88, 0.91, 0, 1); }
                    // Fade out later (0.985 - 0.998)
                    else if (s > 0.985) {
                        gridOpacity = mapRange(s, 0.985, 0.998, 1, 0);
                        dualGridSectionElement.style.transform = `translateY(${mapRange(s, 0.985, 0.998, 0, -50)}px)`;
                    } else { dualGridSectionElement.style.transform = `translateY(0px)`; }

                    dualGridSectionElement.style.opacity = gridOpacity;

                    // Adjusted text fill ranges
                    methTitleElement.textContent = METH_TITLE.substring(0, Math.floor(mapRange(s, 0.88, 0.91, 0, 1) * METH_TITLE.length));
                    methDescElement.textContent = METH_DESC.substring(0, Math.floor(mapRange(s, 0.91, 0.93, 0, 1) * METH_DESC.length));

                    if (s > 0.92) {
                        methKeywordsContainer.style.opacity = 1;
                        if (s > 0.925) methKw1.classList.add('active');
                        if (s > 0.93) methKw2.classList.add('active');
                        if (s > 0.935) methKw3.classList.add('active');
                    } else { methKeywordsContainer.style.opacity = 0; }

                    philTitleElement.textContent = PHIL_TITLE.substring(0, Math.floor(mapRange(s, 0.88, 0.91, 0, 1) * PHIL_TITLE.length));
                    philDescElement.textContent = PHIL_DESC.substring(0, Math.floor(mapRange(s, 0.92, 0.95, 0, 1) * PHIL_DESC.length));
                    if (s > 0.94) { philQuoteContainer.style.opacity = 1; philQuote.classList.add('active'); } else { philQuoteContainer.style.opacity = 0; }
                } else { dualGridSectionElement.style.display = 'none'; }
            }

            if (controls.enabled && keyboardGroup.visible) {
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(keyboardGroup.children, true);
                if (intersects.length > 0) {
                    const newIntersected = intersects[0].object;
                    if (INTERSECTED !== newIntersected) {
                        if (INTERSECTED) INTERSECTED.userData.pressOffset = 0;
                        INTERSECTED = newIntersected;
                        INTERSECTED.userData.pressOffset = -0.05;
                    }
                } else { INTERSECTED = null; }
            }
            controls.update();
            renderer.render(scene, camera);
        }

        window.onload = init;
    </script>
</body>

</html>
